<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>解析lora元数据</title>
    <meta charset="UTF-8">
    <style>
        :root { 
            --bg: #1e1e1e; 
            --bg-panel: #252525;
            --bg-panel-hover: #2d2d2d;
            --text-color: #e0e0e0; 
            --text-muted: #aaa;
            --border-color: #3a3a3a;
            --accent-color: #4dabf7;
            --btn-bg: #4a4a4a;
            --btn-hover-bg: #5a5a5a;
            --btn-action-bg: #4CAF50;
            --btn-action-hover-bg: #5cb85c;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background-color: var(--bg-panel);
            padding: 30px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color);
        }
        .header { 
            text-align: center; 
            font-size: 2em;
            font-weight: bold;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        #link-input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #civitai-url-input {
            flex-grow: 1;
            background-color: #1a1a1a;
            border: 1px solid #555;
            color: var(--text-color);
            border-radius: 5px;
            padding: 10px;
            font-size: 14px;
        }
        #parse-link-btn, #download-lora-btn {
             background-color: var(--accent-color); color: white; border: none;
             padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;
             font-weight: bold; white-space: nowrap;
        }
        #dropArea { 
            width: 100%; 
            border: 2px dashed var(--border-color); 
            text-align: center; 
            padding: 40px 0; 
            margin-bottom: 20px; 
            background-color: var(--bg-panel-hover);
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #dropArea.hover { background-color: #3e3a3e; }
        #dropArea p { margin: 0; font-size: 1.2em; }
        .hidden { display: none; }
        .panel { 
            background-color: var(--bg-panel-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .panel h3 {
            margin-top: 0;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .info-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 10px 20px;
            align-items: start;
        }
        .info-grid dt { font-weight: bold; color: var(--text-muted); text-align: right; padding-top: 2px; }
        .info-grid dd { margin: 0; word-break: break-all; }
        .info-grid a { color: var(--accent-color); text-decoration: none; }
        .info-grid a:hover { text-decoration: underline; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .tag {
            background-color: var(--bg); padding: 4px 10px; border-radius: 15px; font-size: 14px;
            cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid #444;
        }
        .tag:hover { background-color: #333; }
        
        .action-button {
            background-color: var(--btn-bg); color: var(--text-color); border: none;
            padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;
            transition: background-color 0.2s; text-decoration: none; display: inline-block;
            white-space: nowrap;
        }
        .action-button:hover { background-color: var(--btn-hover-bg); }
        .copy-all-btn { font-weight: bold; }
        
        .copy-success { background-color: var(--btn-action-bg) !important; color: white !important; cursor: default !important; }

        #image-viewer { margin-top: 15px; text-align: center; }
        #civitai-preview-image { max-width: 100%; max-height: 70vh; border-radius: 8px; object-fit: contain; background-color: #111; }
        #image-nav { margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
        #image-nav button, #editor-actions button {
            background-color: var(--btn-bg); color: var(--text-color); border: none; padding: 8px 16px; 
            border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s;
        }
        #image-nav button:hover, #editor-actions button:hover { background-color: var(--btn-hover-bg); }
        #image-nav button:disabled { background-color: #333; cursor: not-allowed; opacity: 0.5; }
        #update-lora-button { background-color: var(--btn-action-bg); }
        #update-lora-button:hover { background-color: var(--btn-action-hover-bg); }
        
        .description-content {
            background-color: #1a1a1a; padding: 15px; border-radius: 5px; margin-top: 10px;
            border: 1px solid #333; max-height: 300px; overflow-y: auto;
        }
        .description-content * { max-width: 100%; word-wrap: break-word; }

        #metadata-editor-textarea {
            width: 100%; height: 400px; background-color: #111; color: var(--text-color);
            border: 1px solid #333; border-radius: 4px; font-family: "Fira Code", monospace;
            font-size: 14px; box-sizing: border-box;
        }
        #editor-actions { margin-top: 10px; text-align: right; }

        pre { 
            background: #111; padding: 15px; border-radius: 4px; white-space: pre-wrap;
            word-break: break-all; font-family: "Fira Code", monospace; font-size: 14px;
            border: 1px solid #333; max-height: 400px; overflow-y: auto;
        }
        #loading { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; color: #fff; background: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 10px; z-index: 1001; text-align: center; }
        #loading .spinner { margin: 15px auto; border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #fff; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
  <div class="container" id="main-container">
    <div class="header">
        <span>解析lora元数据</span>
    </div>
    
    <div id="link-input-section">
        <input type="text" id="civitai-url-input" placeholder="粘贴 Civitai 模型或版本链接到这里...">
        <button id="parse-link-btn">解析链接</button>
        <button id="download-lora-btn" class="hidden">下载 LoRA</button>
    </div>

    <div id="dropArea">
      <p>将 .safetensors 文件拖拽到此处(也可以直接点击此处选择lora文件)</p>
    </div>
    
    <div id="loading"><div class="loading-message"></div><div class="spinner"></div></div>

    <div id="resultsPanel" class="hidden">
      
      <div id="civitaiPanel" class="panel hidden">
        <h3>
            <span>Civitai 信息</span>
            <button id="export-triggers-btn" class="action-button hidden">将触发词全部导出为txt文件</button>
        </h3>
        <dl class="info-grid">
          <dt>模型名称</dt><dd id="civitai-model-name">-</dd>
          <dt>创作者</dt><dd id="civitai-creator">-</dd>
          <dt>触发词</dt><dd id="civitai-trained-words" class="tag-container"></dd>
          <dt>基础模型</dt><dd id="civitai-base-model">-</dd>
          <dt>Civitai 链接</dt><dd><a id="civitai-link" href="#" target="_blank">点击查看</a></dd>
        </dl>
        <div id="image-viewer" class="hidden">
            <img id="civitai-preview-image" alt="Civitai Preview Image">
            <div id="image-nav" class="hidden">
                <button id="prev-image-btn">&lt; 上一张</button>
                <span id="image-counter"></span>
                <button id="next-image-btn">下一张 &gt;</button>
                <button id="export-image-btn" class="action-button">导出现在这张图片</button>
            </div>
        </div>
      </div>

      <div id="trainingDetailsPanel" class="panel hidden">
        <h3>训练详情</h3>
        <dl class="info-grid">
            <dt>算法 (Algorithm)</dt><dd id="details-algo">-</dd>
            <dt>学习率 (LR)</dt><dd id="details-lr">-</dd>
            <dt>优化器 (Optimizer)</dt><dd id="details-optimizer">-</dd>
            <dt>图片总数</dt><dd id="details-total-images">-</dd>
            <dt>哈希值(Resource Info)</dt><dd><a id="details-resource-info" href="#" target="_blank">-</a></dd>
        </dl>
      </div>
      
      <div id="descriptionPanel" class="panel hidden">
        <h3>
            <span>模型介绍 & 版本信息</span>
            <button id="export-log-btn" class="action-button">导出介绍为.log</button>
        </h3>
        <h4>模型介绍 (Description)</h4>
        <div id="civitai-description" class="description-content"></div>
        <h4 style="margin-top: 20px;">版本信息 (Version Info)</h4>
        <div id="civitai-version-info" class="description-content"></div>
      </div>

      <div id="editorPanel" class="panel hidden">
        <h3>元数据编辑器</h3>
        <textarea id="metadata-editor-textarea"></textarea>
        <div id="editor-actions">
            <button id="update-lora-button">更新并下载 LoRA</button>
        </div>
      </div>

      <div id="metadataPanel" class="panel hidden">
        <h3>文件元数据 (原始)</h3>
        <pre id="metadataDisplay"></pre>
      </div>

    </div>
  </div>

  <script>
    // --- DOM Element References ---
    const urlInput = document.getElementById('civitai-url-input');
    const parseLinkBtn = document.getElementById('parse-link-btn');
    const downloadLoraBtn = document.getElementById('download-lora-btn');
    const dropArea = document.getElementById('dropArea');
    const loadingDiv = document.getElementById('loading');
    const loadingMessage = document.querySelector('.loading-message');
    const resultsPanel = document.getElementById('resultsPanel');
    const civitaiPanel = document.getElementById('civitaiPanel');
    const descriptionPanel = document.getElementById('descriptionPanel');
    const trainingDetailsPanel = document.getElementById('trainingDetailsPanel');
    const metadataPanel = document.getElementById('metadataPanel');
    const editorPanel = document.getElementById('editorPanel');
    const metadataDisplay = document.getElementById('metadataDisplay');
    const metadataEditorTextarea = document.getElementById('metadata-editor-textarea');
    const updateLoraButton = document.getElementById('update-lora-button');
    const imageViewer = document.getElementById('image-viewer');
    const previewImage = document.getElementById('civitai-preview-image');
    const imageNav = document.getElementById('image-nav');
    const prevBtn = document.getElementById('prev-image-btn');
    const nextBtn = document.getElementById('next-image-btn');
    const imageCounter = document.getElementById('image-counter');
    const trainedWordsDd = document.getElementById('civitai-trained-words');
    const exportLogBtn = document.getElementById('export-log-btn');
    const exportTriggersBtn = document.getElementById('export-triggers-btn');
    const exportImageBtn = document.getElementById('export-image-btn');

    // --- State Variables ---
    let currentImageIndex = 0;
    let imageUrls = [];
    let currentLoraFile = null;
    let currentCivitaiData = null;

    // --- Event Listeners ---
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.safetensors';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => handleFileSelect(fileInput.files[0]));
    dropArea.addEventListener('drop', e => handleFileSelect(e.dataTransfer.files[0]), false);
    
    parseLinkBtn.addEventListener('click', handleLinkParse);
    downloadLoraBtn.addEventListener('click', downloadLoraFromLink);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.add('hover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.remove('hover'), false);
    });
    
    prevBtn.addEventListener('click', showPreviousImage);
    nextBtn.addEventListener('click', showNextImage);
    exportLogBtn.addEventListener('click', exportDescription);
    exportTriggersBtn.addEventListener('click', exportTriggerWords);
    exportImageBtn.addEventListener('click', exportCurrentImage);
    updateLoraButton.addEventListener('click', updateAndDownloadLora);

    // --- Main Handlers ---
    function handleFileSelect(file) {
        if (!file || !file.name.endsWith('.safetensors')) {
            alert('请提供一个有效的 .safetensors 文件。');
            return;
        }
        currentLoraFile = file;
        urlInput.value = '';
        processLora();
    }
    
    async function handleLinkParse() {
        const url = urlInput.value.trim();
        if (!url) {
            alert('请输入一个Civitai链接。');
            return;
        }
        const match = url.match(/civitai\.com\/models\/(\d+)(?:\S*modelVersionId=(\d+))?/);
        if (!match) {
            alert('链接格式无效，请输入一个有效的Civitai模型或版本链接。');
            return;
        }
        const modelId = match[1];
        const versionId = match[2];

        clearResults();
        showLoading('正在通过链接解析...');

        try {
            let civitaiData;
            if (versionId) {
                civitaiData = await fetchCivitaiDataById(versionId, 'version');
            } else {
                const modelData = await fetchCivitaiDataById(modelId, 'model');
                if (modelData && modelData.modelVersions && modelData.modelVersions.length > 0) {
                    civitaiData = await fetchCivitaiDataById(modelData.modelVersions[0].id, 'version');
                }
            }

            if (civitaiData) {
                currentCivitaiData = civitaiData;
                metadataPanel.classList.add('hidden');
                trainingDetailsPanel.classList.add('hidden');
                editorPanel.classList.add('hidden');
                
                displayCivitaiData(civitaiData);
                civitaiPanel.classList.remove('hidden');
                descriptionPanel.classList.remove('hidden');
                resultsPanel.classList.remove('hidden');
                downloadLoraBtn.classList.remove('hidden');
            } else {
                alert('无法从链接获取信息，请检查链接或稍后再试。');
            }
        } catch(error) {
            console.error('通过链接解析时发生错误:', error);
            alert(`通过链接解析时发生错误: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    async function processLora() {
      showLoading('正在处理文件...');
      try {
        const metadata = await parseSafetensorsMetadata(currentLoraFile);
        showLoading('正在计算哈希值...');
        const hash = await calculateFileHash(currentLoraFile);
        const shortHash = hash.substring(0, 10);
        showLoading('正在查询 Civitai...');
        const civitaiData = await fetchCivitaiDataByHash(shortHash);
        currentCivitaiData = civitaiData;

        if (metadata) {
            displayInternalMetadata(metadata, shortHash);
            metadataPanel.classList.remove('hidden');
            trainingDetailsPanel.classList.remove('hidden');
            editorPanel.classList.remove('hidden');
        }
        if (civitaiData) {
          displayCivitaiData(civitaiData);
          civitaiPanel.classList.remove('hidden');
          descriptionPanel.classList.remove('hidden');
        }
        resultsPanel.classList.remove('hidden');
      } catch (error) {
        console.error('处理文件时发生错误:', error);
        alert(`处理文件时发生错误: ${error.message}`);
      } finally {
        hideLoading();
      }
    }
    
    // --- UI Update & Display Functions ---
    function showLoading(message) {
        loadingMessage.textContent = message;
        loadingDiv.style.display = 'block';
    }

    function hideLoading() {
        loadingDiv.style.display = 'none';
    }

    function clearResults() {
        resultsPanel.classList.add('hidden');
        civitaiPanel.classList.add('hidden');
        descriptionPanel.classList.add('hidden');
        trainingDetailsPanel.classList.add('hidden');
        metadataPanel.classList.add('hidden');
        editorPanel.classList.add('hidden');
        imageViewer.classList.add('hidden');
        imageNav.classList.add('hidden');
        exportTriggersBtn.classList.add('hidden');
        downloadLoraBtn.classList.add('hidden');
        imageUrls = [];
        currentImageIndex = 0;
        currentLoraFile = null;
        currentCivitaiData = null;
    }

    function displayInternalMetadata(metadata, hash) {
        const coloredJson = JSON.stringify(metadata, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;');
        metadataDisplay.innerHTML = coloredJson;
        metadataEditorTextarea.value = JSON.stringify(metadata, null, 2);
        
        const networkArgs = metadata.ss_network_args ? JSON.parse(metadata.ss_network_args) : {};
        document.getElementById('details-algo').textContent = networkArgs.algo || '未知';
        document.getElementById('details-lr').textContent = metadata.ss_learning_rate || '未知';
        document.getElementById('details-optimizer').textContent = metadata.ss_optimizer_type || (metadata.ss_optimizer || '').split('(')[0].trim() || '未知';
        let totalImages = 0;
        if (metadata.ss_dataset_dirs) {
            try {
                const datasets = JSON.parse(metadata.ss_dataset_dirs);
                totalImages = Object.values(datasets).reduce((sum, dir) => sum + (dir.img_count || 0), 0);
            } catch(e) { console.error("无法解析ss_dataset_dirs"); }
        }
        document.getElementById('details-total-images').textContent = totalImages > 0 ? totalImages : '未知';
        const resourceLink = document.getElementById('details-resource-info');
        const resourceUrl = `https://civitai.com/api/v1/model-versions/by-hash/${hash}`;
        resourceLink.href = resourceUrl;
        resourceLink.textContent = resourceUrl;
    }
    
    function displayCivitaiData(data) {
        document.getElementById('civitai-model-name').textContent = data.model?.name || '未知';
        document.getElementById('civitai-creator').textContent = data.model?.creator?.username || '未知';
        document.getElementById('civitai-base-model').textContent = data.baseModel || '未知';
        
        trainedWordsDd.innerHTML = ''; 
        const words = data.trainedWords;
        if (words && words.length > 0) {
            words.forEach(word => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = word;
                tag.onclick = (e) => copyToClipboard(word, e.target);
                trainedWordsDd.appendChild(tag);
            });
            const copyAll = document.createElement('button');
            copyAll.className = 'action-button copy-all-btn';
            copyAll.textContent = '[复制全部]';
            copyAll.onclick = (e) => copyToClipboard(words.join(', '), e.target);
            trainedWordsDd.appendChild(copyAll);
            exportTriggersBtn.classList.remove('hidden');
        } else {
            trainedWordsDd.textContent = '无';
            exportTriggersBtn.classList.add('hidden');
        }

        const link = document.getElementById('civitai-link');
        const modelUrl = `https://civitai.com/models/${data.modelId}?modelVersionId=${data.id}`;
        link.href = modelUrl;
        link.textContent = '在 Civitai.com 上查看';
        
        document.getElementById('civitai-description').innerHTML = data.model?.description || '无';
        document.getElementById('civitai-version-info').innerHTML = data.description || '无';

        if (data.images && data.images.length > 0) {
            imageUrls = data.images.map(img => img.url);
            currentImageIndex = 0;
            updateImageViewer();
            imageViewer.classList.remove('hidden');
        }
    }
    
    // --- Feature Functions ---
    function copyToClipboard(text, element) {
        if (text && text !== '无' && text !== '-') {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.textContent;
                element.textContent = '✓ 复制成功!';
                element.classList.add('copy-success');
                setTimeout(() => {
                    element.textContent = originalText;
                    element.classList.remove('copy-success');
                }, 1500);
            }).catch(err => {
                console.error('无法复制文本: ', err);
            });
        }
    }

    function exportContent(content, filename) {
        const baseName = currentLoraFile?.name.replace('.safetensors', '') || `civitai_${document.getElementById('civitai-model-name').textContent.replace(/\s/g, '_')}`;
        const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${baseName}${filename}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    function exportDescription() {
        const modelDesc = document.getElementById('civitai-description').innerText;
        const versionDesc = document.getElementById('civitai-version-info').innerText;
        const content = `--- 模型介绍 ---\n\n${modelDesc}\n\n--- 版本信息 ---\n\n${versionDesc}`;
        exportContent(content, `.log`);
    }

    function exportTriggerWords() {
        const wordsContainer = document.getElementById('civitai-trained-words');
        const tags = Array.from(wordsContainer.querySelectorAll('.tag')).map(t => t.textContent);
        if(tags.length > 0) {
            exportContent(tags.join(', '), `.txt`);
        }
    }
    
    async function exportCurrentImage() {
        if (imageUrls.length === 0) return;
        const url = imageUrls[currentImageIndex];
        
        showLoading(`正在下载图片...`);
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`无法获取图片: ${response.statusText}`);
            const blob = await response.blob();
            
            let extension = '.jpg';
            try {
                const urlPath = new URL(url).pathname;
                const urlParts = urlPath.split('.');
                if (urlParts.length > 1) {
                    const ext = urlParts.pop().toLowerCase();
                    if (['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(ext)) {
                        extension = `.${ext}`;
                    }
                }
            } catch(e) { console.error("无法从URL解析图片格式, 默认使用.jpg"); }
            
            const baseName = currentLoraFile?.name.replace('.safetensors', '') || `civitai_${document.getElementById('civitai-model-name').textContent.replace(/\s/g, '_')}`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${baseName}_image_${currentImageIndex}${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (error) {
            console.error('图片下载失败:', error);
            alert(`图片下载失败: ${error.message}. 您可以尝试右键点击图片手动保存。`);
        } finally {
            hideLoading();
        }
    }
    
    async function updateAndDownloadLora() {
        if (!currentLoraFile) {
            alert("请先加载一个LoRA文件。");
            return;
        }
        let newMetadata;
        try {
            newMetadata = JSON.parse(metadataEditorTextarea.value);
        } catch(e) {
            alert("元数据格式错误！请确保内容是有效的JSON。");
            return;
        }
        showLoading('正在重新构建文件...');
        try {
            const fileBuffer = await currentLoraFile.arrayBuffer();
            const view = new DataView(fileBuffer);
            const metadataLength = Number(view.getBigUint64(0, true));
            const newHeader = { "__metadata__": newMetadata };
            const newHeaderBytes = new TextEncoder().encode(JSON.stringify(newHeader));
            const newFileBuffer = new ArrayBuffer(8 + newHeaderBytes.length + (fileBuffer.byteLength - 8 - metadataLength));
            const newView = new DataView(newFileBuffer);
            newView.setBigUint64(0, BigInt(newHeaderBytes.length), true);
            const newUint8Array = new Uint8Array(newFileBuffer);
            newUint8Array.set(newHeaderBytes, 8);
            const tensorData = new Uint8Array(fileBuffer, 8 + metadataLength);
            newUint8Array.set(tensorData, 8 + newHeaderBytes.length);
            const blob = new Blob([newFileBuffer], { type: "application/octet-stream" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${currentLoraFile.name.replace('.safetensors', '')}_edited.safetensors`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch(error) {
            alert(`更新文件失败: ${error.message}`);
            console.error(error);
        } finally {
            hideLoading();
        }
    }

    async function downloadLoraFromLink() {
        if (!currentCivitaiData || !currentCivitaiData.downloadUrl) {
            alert('没有可用的下载链接。');
            return;
        }
        showLoading('正在准备下载 LoRA...');
        try {
            const filename = currentCivitaiData.files[0]?.name || 'lora.safetensors';
            // Simplest method: open the link in a new tab. 
            // Fetching can be blocked by CORS. This is more reliable.
            // window.open(currentCivitaiData.downloadUrl, '_blank');
            
            // Direct download method
            const a = document.createElement('a');
            a.href = currentCivitaiData.downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

        } catch(error) {
            console.error('LoRA 下载失败:', error);
            alert(`LoRA 下载失败: ${error.message}`);
        } finally {
            hideLoading();
        }
    }


    // --- Image Viewer Logic ---
    function updateImageViewer() {
        if (imageUrls.length === 0) return;
        previewImage.src = imageUrls[currentImageIndex];
        imageCounter.textContent = `${currentImageIndex + 1} / ${imageUrls.length}`;
        prevBtn.disabled = currentImageIndex === 0;
        nextBtn.disabled = currentImageIndex === imageUrls.length - 1;
        imageNav.classList.toggle('hidden', imageUrls.length < 1); // Show even for 1 image
    }
    function showNextImage() {
        if (currentImageIndex < imageUrls.length - 1) {
            currentImageIndex++;
            updateImageViewer();
        }
    }
    function showPreviousImage() {
        if (currentImageIndex > 0) {
            currentImageIndex--;
            updateImageViewer();
        }
    }

    // --- Core File & API Functions ---
    async function parseSafetensorsMetadata(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const buffer = e.target.result;
            const view = new DataView(buffer);
            const metadataLength = Number(view.getBigUint64(0, true));
            if (metadataLength === 0) { resolve(null); return; }
            const metadataJson = new TextDecoder().decode(new Uint8Array(buffer, 8, metadataLength));
            const header = JSON.parse(metadataJson);
            resolve(header['__metadata__'] || null);
          } catch (err) { reject(new Error("解析元数据失败。")); }
        };
        reader.onerror = () => reject(new Error('无法读取文件。'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function calculateFileHash(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const buffer = e.target.result;
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    resolve(hashArray.map(b => b.toString(16).padStart(2, '0')).join(''));
                } catch (err) { reject(err); }
            };
            reader.onerror = () => reject(new Error('无法读取文件以计算哈希。'));
            reader.readAsArrayBuffer(file);
        });
    }

    async function fetchCivitaiDataByHash(hash) {
      try {
        const response = await fetch(`https://civitai.com/api/v1/model-versions/by-hash/${hash}`);
        if (!response.ok) return null;
        let data = await response.json();
        const modelResponse = await fetch(`https://civitai.com/api/v1/models/${data.modelId}`);
        data.model = await modelResponse.json();
        return data;
      } catch (error) {
        console.error("Civitai API 请求失败 (by hash):", error);
        return null;
      }
    }
    
    async function fetchCivitaiDataById(id, type = 'version') {
        let url;
        if (type === 'version') {
            url = `https://civitai.com/api/v1/model-versions/${id}`;
        } else {
            url = `https://civitai.com/api/v1/models/${id}`;
        }
        try {
            const response = await fetch(url);
            if (!response.ok) return null;
            let data = await response.json();
            if (type === 'version' && data.modelId) {
                const modelResponse = await fetch(`https://civitai.com/api/v1/models/${data.modelId}`);
                data.model = await modelResponse.json();
            }
            return data;
        } catch (error) {
            console.error(`Civitai API 请求失败 (by ${type} id):`, error);
            return null;
        }
    }
  </script>
</body>
</html>