<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>解析lora元数据</title>
    <meta charset="UTF-8">
    <style>
        /* Theme Variables - UI controls (left side) */
        :root[data-theme="dark"] { 
            --ui-bg: #1e1e1e; 
            --ui-bg-panel: #252525;
            --ui-bg-panel-hover: #2d2d2d;
            --ui-text-color: #e0e0e0; 
            --ui-text-muted: #aaa;
            --ui-border-color: #3a3a3a;
            --ui-accent-color: #4dabf7; /* Default accent for UI elements */
            --ui-btn-bg: #4a4a4a;
            --ui-btn-hover-bg: #5a5a5a;
            --ui-btn-action-bg: #4CAF50;
            --ui-btn-action-hover-bg: #5cb85c;
            --ui-drop-area-bg: #2d2d2d;
            --ui-drop-area-hover: #3e3a3e;
            --ui-gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --ui-gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --ui-glow-color: rgba(74, 171, 247, 0.3); /* Default glow for UI elements */
        }

        :root[data-theme="light"] {
            --ui-bg: #f8f9fa;
            --ui-bg-panel: #ffffff;
            --ui-bg-panel-hover: #f1f3f4;
            --ui-text-color: #212529;
            --ui-text-muted: #6c757d;
            --ui-border-color: #dee2e6;
            --ui-accent-color: #0d6efd;
            --ui-btn-bg: #e9ecef;
            --ui-btn-hover-bg: #dee2e6;
            --ui-btn-action-bg: #198754;
            --ui-btn-action-hover-bg: #157347;
            --ui-drop-area-bg: #f8f9fa;
            --ui-drop-area-hover: #e9ecef;
            --ui-gradient-primary: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            --ui-gradient-secondary: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            --ui-glow-color: rgba(13, 110, 253, 0.3);
        }

        :root[data-theme="blue"] {
            --ui-bg: #0f1419;
            --ui-bg-panel: #1a2332;
            --ui-bg-panel-hover: #243447;
            --ui-text-color: #e6f1ff;
            --ui-text-muted: #8bb9fe;
            --ui-border-color: #2d4663;
            --ui-accent-color: #00d4ff;
            --ui-btn-bg: #2d4663;
            --ui-btn-hover-bg: #3a5a7a;
            --ui-btn-action-bg: #0066cc;
            --ui-btn-action-hover-bg: #0052a3;
            --ui-drop-area-bg: #243447;
            --ui-drop-area-hover: #2d4663;
            --ui-gradient-primary: linear-gradient(135deg, #00d4ff 0%, #0066cc 100%);
            --ui-gradient-secondary: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            --ui-glow-color: rgba(0, 212, 255, 0.3);
        }

        :root[data-theme="purple"] {
            --ui-bg: #1a0d26;
            --ui-bg-panel: #2d1b3d;
            --ui-bg-panel-hover: #3d2952;
            --ui-text-color: #f0e6ff;
            --ui-text-muted: #c299ff;
            --ui-border-color: #4d3366;
            --ui-accent-color: #a855f7;
            --ui-btn-bg: #4d3366;
            --ui-btn-hover-bg: #5c3d7a;
            --ui-btn-action-bg: #7c3aed;
            --ui-btn-action-hover-bg: #6d28d9;
            --ui-drop-area-bg: #3d2952;
            --ui-drop-area-hover: #4d3366;
            --ui-gradient-primary: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            --ui-gradient-secondary: linear-gradient(135deg, #e17cff 0%, #c084fc 100%);
            --ui-glow-color: rgba(168, 85, 247, 0.3);
        }

        :root[data-theme="green"] {
            --ui-bg: #0d1f0d;
            --ui-bg-panel: #1a331a;
            --ui-bg-panel-hover: #264d26;
            --ui-text-color: #e6ffe6;
            --ui-text-muted: #99cc99;
            --ui-border-color: #336633;
            --ui-accent-color: #22c55e;
            --ui-btn-bg: #336633;
            --ui-btn-hover-bg: #4d7a4d;
            --ui-btn-action-bg: #16a34a;
            --ui-btn-action-hover-bg: #15803d;
            --ui-drop-area-bg: #264d26;
            --ui-drop-area-hover: #336633;
            --ui-gradient-primary: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --ui-gradient-secondary: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
            --ui-glow-color: rgba(34, 197, 94, 0.3);
        }

        :root[data-theme="orange"] {
            --ui-bg: #1f1408;
            --ui-bg-panel: #332211;
            --ui-bg-panel-hover: #4d3319;
            --ui-text-color: #fff5e6;
            --ui-text-muted: #ffcc99;
            --ui-border-color: #664422;
            --ui-accent-color: #f97316;
            --ui-btn-bg: #664422;
            --ui-btn-hover-bg: #7a5533;
            --ui-btn-action-bg: #ea580c;
            --ui-btn-action-hover-bg: #c2410c;
            --ui-drop-area-bg: #4d3319;
            --ui-drop-area-hover: #664422;
            --ui-gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            --ui-gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --ui-glow-color: rgba(249, 115, 22, 0.3);
        }

        /* Element Theme Variables (right side, for background, particles, shapes, mouse trail) */
        :root {
            --element-bg: var(--ui-bg); /* Default to current UI theme's bg */
            --element-particle-color: var(--ui-accent-color); /* Default to current UI theme's accent */
            --element-glow-color: var(--ui-glow-color); /* Default to current UI theme's glow */
            --mouse-particle-color: cyan; /* Default techy mouse particle color */
            --mouse-line-color: cyan;
            --mouse-line-glow: rgba(0, 255, 255, 0.5);
        }

        /* Background Decorations */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--element-bg); /* Use element theme background */
            z-index: -3;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, var(--element-glow-color) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--element-glow-color) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--element-glow-color) 0%, transparent 50%),
                radial-gradient(circle at 60% 70%, var(--element-glow-color) 0%, transparent 30%);
            z-index: -2;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
            25% { transform: translateY(-30px) rotate(2deg) scale(1.1); }
            50% { transform: translateY(20px) rotate(-1deg) scale(0.9); }
            75% { transform: translateY(-10px) rotate(1deg) scale(1.05); }
        }

        /* Geometric decorations (background) */
        .geometric-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .geometric-shape {
            position: absolute;
            opacity: 0.1;
            animation: geometric-float 25s infinite linear;
        }

        .shape-triangle {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 25px solid var(--element-particle-color); /* Use element color */
        }

        .shape-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--element-particle-color); /* Use element color */
        }

        .shape-square {
            width: 18px;
            height: 18px;
            background: var(--element-particle-color); /* Use element color */
            transform: rotate(45deg);
        }

        .shape-hexagon {
            width: 20px;
            height: 11px;
            background: var(--element-particle-color); /* Use element color */
            position: relative;
        }

        .shape-hexagon:before,
        .shape-hexagon:after {
            content: "";
            position: absolute;
            width: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
        }

        .shape-hexagon:before {
            bottom: 100%;
            border-bottom: 6px solid var(--element-particle-color); /* Use element color */
        }

        .shape-hexagon:after {
            top: 100%;
            border-top: 6px solid var(--element-particle-color); /* Use element color */
        }

        @keyframes geometric-float {
            0% {
                transform: translateY(100vh) translateX(0px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.1;
            }
            90% {
                opacity: 0.1;
            }
            100% {
                transform: translateY(-100px) translateX(50px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Enhanced particles (background) */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            animation: particle-float 20s infinite linear;
        }

        .particle-small {
            width: 3px;
            height: 3px;
            background: var(--element-particle-color); /* Use element color */
        }

        .particle-medium {
            width: 6px;
            height: 6px;
            background: var(--element-particle-color); /* Use element color */
            box-shadow: 0 0 10px var(--element-glow-color); /* Use element glow */
        }

        .particle-large {
            width: 8px;
            height: 8px;
            background: var(--element-particle-color); /* Use element color */
            box-shadow: 0 0 15px var(--element-glow-color); /* Use element glow */
        }

        .particle-glow {
            width: 4px;
            height: 4px;
            background: var(--element-particle-color); /* Use element color */
            box-shadow: 0 0 20px var(--element-glow-color), 0 0 40px var(--element-glow-color); /* Use element glow */
            animation: particle-glow 20s infinite linear, pulse 3s infinite;
        }

        @keyframes particle-float {
            0% {
                transform: translateY(100vh) translateX(0px) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
                transform: scale(1);
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(200px) scale(0);
                opacity: 0;
            }
        }

        @keyframes particle-glow {
            0% {
                transform: translateY(100vh) translateX(0px) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
                transform: scale(1);
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) translateX(150px) scale(0);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        /* Techy Mouse Particle Canvas */
        #mouse-particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999; /* Above background elements, below UI */
        }

        /* Ripple effect (for buttons) */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: var(--ui-glow-color); /* Use UI glow for ripples */
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Base Styles */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            color: var(--ui-text-color); 
            margin: 0; 
            padding: 20px;
            transition: color 0.3s ease;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: var(--ui-bg-panel);
            backdrop-filter: blur(20px);
            padding: 30px; 
            border-radius: 25px; 
            border: 1px solid var(--ui-border-color);
            transition: all 0.3s ease;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.05) inset,
                0 0 100px var(--ui-glow-color); /* Use UI glow */
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--ui-gradient-primary);
            opacity: 0.8;
            animation: glow-pulse 3s ease-in-out infinite;
        }

        .container::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle, var(--ui-glow-color) 1px, transparent 1px), /* Use UI glow */
                radial-gradient(circle at 70% 70%, var(--ui-glow-color) 1px, transparent 1px); /* Use UI glow */
            background-size: 50px 50px;
            opacity: 0.03;
            animation: pattern-drift 30s linear infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes pattern-drift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .header { 
            text-align: center; 
            font-size: 2em;
            font-weight: bold;
            border-bottom: 2px solid var(--ui-border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: var(--ui-gradient-primary);
            border-radius: 2px;
            animation: header-glow 2s ease-in-out infinite;
        }

        @keyframes header-glow {
            0%, 100% { box-shadow: 0 0 10px var(--ui-glow-color); } /* Use UI glow */
            50% { box-shadow: 0 0 20px var(--ui-glow-color), 0 0 30px var(--ui-glow-color); } /* Use UI glow */
        }

        .controls-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* Particle toggle switch */
        .particle-switch-container {
            position: fixed; /* Fixed position */
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column; /* Stack vertically */
            align-items: flex-start; /* Align items to the start */
            gap: 10px;
            z-index: 1000;
            background: var(--ui-bg-panel);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--ui-border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            color: var(--ui-text-color);
        }

        .particle-control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .particle-control-group label {
            cursor: pointer;
            font-size: 14px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-left: 5px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--ui-border-color);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--ui-accent-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--ui-accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Radio button styling */
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px; /* Spacing from particle toggle */
        }
        .radio-group input[type="radio"] {
            display: none;
        }
        .radio-group label {
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid var(--ui-border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            background-color: var(--ui-bg-panel);
            color: var(--ui-text-muted);
        }
        .radio-group input[type="radio"]:checked + label {
            background-color: var(--ui-accent-color);
            color: white;
            border-color: var(--ui-accent-color);
            box-shadow: 0 0 8px var(--ui-glow-color);
        }
        .radio-group label:hover {
            background-color: var(--ui-bg-panel-hover);
        }


        .theme-selector, .bg-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 10px;
            background: var(--ui-bg-panel-hover);
            border-radius: 20px;
            border: 1px solid var(--ui-border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .theme-selector::before, .bg-selector::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--ui-glow-color), transparent); /* Use UI glow */
            animation: selector-shine 4s infinite;
        }

        @keyframes selector-shine {
            0% { left: -100%; }
            50% { left: -100%; }
            100% { left: 100%; }
        }

        .theme-btn, .bg-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--ui-border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .theme-btn:hover, .bg-btn:hover {
            transform: scale(1.3);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3), 0 0 30px var(--ui-glow-color); /* Use UI glow */
        }

        .theme-btn.active, .bg-btn.active {
            transform: scale(1.4);
            box-shadow: 0 0 0 3px var(--ui-accent-color), 0 0 30px var(--ui-glow-color); /* Use UI glow */
            animation: active-pulse 2s infinite;
        }

        @keyframes active-pulse {
            0%, 100% { box-shadow: 0 0 0 3px var(--ui-accent-color), 0 0 30px var(--ui-glow-color); } /* Use UI glow */
            50% { box-shadow: 0 0 0 5px var(--ui-accent-color), 0 0 40px var(--ui-glow-color); } /* Use UI glow */
        }

        .theme-btn[data-theme="dark"] { background: linear-gradient(45deg, #1e1e1e, #4dabf7); }
        .theme-btn[data-theme="light"] { background: linear-gradient(45deg, #ffffff, #0d6efd); }
        .theme-btn[data-theme="blue"] { background: linear-gradient(45deg, #0f1419, #00d4ff); }
        .theme-btn[data-theme="purple"] { background: linear-gradient(45deg, #1a0d26, #a855f7); }
        .theme-btn[data-theme="green"] { background: linear-gradient(45deg, #0d1f0d, #22c55e); }
        .theme-btn[data-theme="orange"] { background: linear-gradient(45deg, #1f1408, #f97316); }

        /* New background element themes */
        .bg-btn[data-bg="ice"] { background: linear-gradient(45deg, #a0d8f0, #d0efff); }
        .bg-btn[data-bg="fire"] { background: linear-gradient(45deg, #ff4500, #ffa500); }
        .bg-btn[data-bg="electric"] { background: linear-gradient(45deg, #8a2be2, #40e0d0); }
        .bg-btn[data-bg="grass"] { background: linear-gradient(45deg, #6b8e23, #9acd32); }
        .bg-btn[data-bg="candy"] { background: linear-gradient(45deg, #ffb6c1, #ff69b4); }


        #link-input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        #link-input-section::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: var(--ui-gradient-primary);
            border-radius: 15px;
            opacity: 0.1;
            z-index: -1;
            animation: section-glow 4s ease-in-out infinite;
        }

        @keyframes section-glow {
            0%, 100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(1.02); }
        }

        #civitai-url-input {
            flex-grow: 1;
            background: var(--ui-bg);
            border: 2px solid var(--ui-border-color);
            color: var(--ui-text-color);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #civitai-url-input:focus {
            outline: none;
            border-color: var(--ui-accent-color);
            box-shadow: 0 0 0 4px var(--ui-glow-color), 0 10px 25px rgba(0,0,0,0.2); /* Use UI glow */
            transform: translateY(-2px);
        }

        #parse-link-btn, #download-lora-btn {
            background: var(--ui-gradient-primary);
            color: white; 
            border: none;
            padding: 15px 30px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: bold; 
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #parse-link-btn::before, #download-lora-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        #parse-link-btn:hover::before, #download-lora-btn:hover::before {
            left: 100%;
        }

        #parse-link-btn:hover, #download-lora-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3), 0 0 30px var(--ui-glow-color); /* Use UI glow */
        }

        #dropArea { 
            width: 100%; 
            border: 3px dashed var(--ui-border-color); 
            text-align: center; 
            padding: 80px 20px; 
            margin-bottom: 20px; 
            background: var(--ui-drop-area-bg);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.1);
        }

        #dropArea::before {
            content: '📁';
            font-size: 4em;
            display: block;
            margin-bottom: 15px;
            animation: bounce 2s infinite, rotate-slight 4s ease-in-out infinite;
            filter: drop-shadow(0 0 10px var(--ui-glow-color)); /* Use UI glow */
        }

        #dropArea::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, var(--ui-glow-color) 2px, transparent 2px), /* Use UI glow */
                radial-gradient(circle at 70% 70%, var(--ui-glow-color) 1px, transparent 1px); /* Use UI glow */
            background-size: 40px 40px, 20px 20px;
            opacity: 0.1;
            animation: pattern-move 10s linear infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-15px); }
            60% { transform: translateY(-8px); }
        }

        @keyframes rotate-slight {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-2deg); }
        }

        @keyframes pattern-move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }

        #dropArea.hover { 
            background: var(--ui-drop-area-hover);
            border-color: var(--ui-accent-color);
            transform: scale(1.03);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3), 0 0 50px var(--ui-glow-color); /* Use UI glow */
        }

        #dropArea p { margin: 0; font-size: 1.3em; font-weight: 500; }

        .hidden { display: none; }

        .panel { 
            background: var(--ui-bg-panel-hover);
            backdrop-filter: blur(15px);
            border: 1px solid var(--ui-border-color);
            border-radius: 20px;
            padding: 30px;
            margin-top: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--ui-gradient-primary);
            opacity: 0.8;
            animation: panel-glow 3s ease-in-out infinite;
        }

        .panel::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            background: var(--ui-glow-color); /* Use UI glow */
            border-radius: 50%;
            opacity: 0.05;
            animation: corner-pulse 4s ease-in-out infinite;
        }

        @keyframes panel-glow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 20px var(--ui-glow-color); } /* Use UI glow */
        }

        @keyframes corner-pulse {
            0%, 100% { transform: scale(1); opacity: 0.05; }
            50% { transform: scale(1.2); opacity: 0.1; }
        }

        .panel:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.2), 0 0 50px var(--ui-glow-color); /* Use UI glow */
        }

        .panel h3 {
            margin-top: 0;
            color: var(--ui-accent-color);
            border-bottom: 2px solid var(--ui-border-color);
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.4em;
            position: relative;
            z-index: 1;
        }

        .panel h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--ui-accent-color);
            animation: title-glow 2s ease-in-out infinite;
        }

        @keyframes title-glow {
            0%, 100% { box-shadow: 0 0 10px var(--ui-glow-color); } /* Use UI glow */
            50% { box-shadow: 0 0 20px var(--ui-glow-color); } /* Use UI glow */
        }

        .info-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 18px 30px;
            align-items: start;
            position: relative;
            z-index: 1;
        }

        .info-grid dt { 
            font-weight: bold; 
            color: var(--ui-text-muted); 
            text-align: right; 
            padding-top: 2px;
            position: relative;
        }

        .info-grid dt::after {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: var(--ui-accent-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--ui-glow-color); /* Use UI glow */
            animation: dot-pulse 2s ease-in-out infinite;
        }

        @keyframes dot-pulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.3); }
        }

        .info-grid dd { margin: 0; word-break: break-all; }
        .info-grid a { 
            color: var(--ui-accent-color); 
            text-decoration: none; 
            transition: all 0.3s ease;
            position: relative;
        }
        .info-grid a:hover { 
            text-decoration: underline;
            filter: brightness(1.2);
            text-shadow: 0 0 10px var(--ui-glow-color); /* Use UI glow */
        }
        
        .tag-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            align-items: center; 
        }

        .tag {
            background: var(--ui-bg); 
            padding: 10px 18px; 
            border-radius: 25px; 
            font-size: 14px;
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 1px solid var(--ui-border-color);
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--ui-gradient-primary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .tag:hover::before {
            left: 0;
        }

        .tag:hover { 
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 20px var(--ui-glow-color); /* Use UI glow */
        }
        
        .action-button {
            background: var(--ui-btn-bg); 
            color: var(--ui-text-color); 
            border: none;
            padding: 10px 20px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 12px;
            transition: all 0.3s ease; 
            text-decoration: none; 
            display: inline-block;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--ui-gradient-secondary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .action-button:hover::before {
            left: 0;
        }

        .action-button:hover { 
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 20px var(--ui-glow-color); /* Use UI glow */
        }

        .copy-all-btn { font-weight: bold; }
        
        .copy-success { 
            background: var(--ui-btn-action-bg) !important; 
            color: white !important; 
            cursor: default !important; 
        }

        #image-viewer { margin-top: 25px; text-align: center; }
        #civitai-preview-image { 
            max-width: 100%; 
            max-height: 70vh; 
            border-radius: 20px; 
            object-fit: contain; 
            background: var(--ui-bg);
            transition: all 0.3s ease;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3), 0 0 30px var(--ui-glow-color); /* Use UI glow */
        }
        #civitai-preview-image:hover {
            transform: scale(1.03);
            box-shadow: 0 25px 60px rgba(0,0,0,0.4), 0 0 50px var(--ui-glow-color); /* Use UI glow */
        }

        #image-nav { 
            margin-top: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 20px; 
            flex-wrap: wrap; 
        }

        #image-nav button, #editor-actions button {
            background: var(--ui-btn-bg); 
            color: var(--ui-text-color); 
            border: none; 
            padding: 12px 24px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #image-nav button::before, #editor-actions button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--ui-gradient-primary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        #image-nav button:hover::before, #editor-actions button:hover::before {
            left: 0;
        }

        #image-nav button:hover, #editor-actions button:hover { 
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 25px var(--ui-glow-color); /* Use UI glow */
        }

        #image-nav button:disabled { 
            background: var(--ui-border-color); 
            cursor: not-allowed; 
            opacity: 0.5;
            transform: none;
        }

        #image-nav button:disabled::before {
            display: none;
        }

        #update-lora-button { 
            background: var(--ui-gradient-secondary); 
            color: white;
        }
        
        .description-content {
            background: var(--ui-bg); 
            padding: 25px; 
            border-radius: 15px; 
            margin-top: 20px;
            border: 1px solid var(--ui-border-color); 
            max-height: 300px; 
            overflow-y: auto;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .description-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--ui-gradient-primary);
            opacity: 0.6;
        }

        .description-content * { max-width: 100%; word-wrap: break-word; }

        #metadata-editor-textarea {
            width: 100%; 
            height: 400px; 
            background: var(--ui-bg); 
            color: var(--ui-text-color);
            border: 2px solid var(--ui-border-color); 
            border-radius: 15px; 
            font-family: "Fira Code", monospace;
            font-size: 14px; 
            box-sizing: border-box;
            transition: all 0.3s ease;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #metadata-editor-textarea:focus {
            outline: none;
            border-color: var(--ui-accent-color);
            box-shadow: 0 0 0 4px var(--ui-glow-color), 0 10px 25px rgba(0,0,0,0.2); /* Use UI glow */
        }

        #editor-actions { margin-top: 20px; text-align: right; }

        pre { 
            background: var(--ui-bg); 
            padding: 25px; 
            border-radius: 15px; 
            white-space: pre-wrap;
            word-break: break-all; 
            font-family: "Fira Code", monospace; 
            font-size: 14px;
            border: 1px solid var(--ui-border-color); 
            max-height: 400px; 
            overflow-y: auto;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        pre::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--ui-gradient-primary);
            opacity: 0.6;
        }

        #loading { 
            display: none; 
            position: fixed; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 1.3rem; 
            color: var(--ui-text-color); 
            background: var(--ui-bg-panel); 
            backdrop-filter: blur(30px);
            padding: 40px; 
            border-radius: 20px; 
            z-index: 1001; 
            text-align: center;
            border: 1px solid var(--ui-border-color);
            box-shadow: 0 30px 80px rgba(0,0,0,0.4), 0 0 50px var(--ui-glow-color); /* Use UI glow */
        }

        #loading .spinner { 
            margin: 25px auto; 
            border: 5px solid var(--ui-border-color); 
            border-radius: 50%; 
            border-top: 5px solid var(--ui-accent-color); 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
            box-shadow: 0 0 30px var(--ui-glow-color); /* Use UI glow */
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--ui-bg-panel);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--ui-accent-color);
            border-radius: 5px;
            box-shadow: 0 0 10px var(--ui-glow-color); /* Use UI glow */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--ui-accent-color);
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--ui-glow-color); /* Use UI glow */
        }

        /* Smooth transitions for theme changes */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Element Decorations Container */
        #element-decorations {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -0.5; /* Below geometric-bg and particles but above body::before */
            overflow: hidden;
        }

        /* Individual Element Decoration Styles */
        .decoration-element {
            position: absolute;
            opacity: 0; /* Will be set to 1 by JS after creation */
            transition: opacity 0.5s ease-out;
        }

        /* Ice Theme - Snowflakes (more defined shape) */
        .snowflake {
            width: 15px;
            height: 15px;
            background-color: transparent;
            position: relative;
            transform: rotate(45deg); /* Make it a diamond */
            box-shadow: 0 0 10px white, 0 0 20px var(--element-glow-color);
            animation: snowfall linear infinite;
        }
        .snowflake::before, .snowflake::after {
            content: '';
            position: absolute;
            background-color: white;
        }
        .snowflake::before { /* Horizontal arm */
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        .snowflake::after { /* Vertical arm */
            width: 2px;
            height: 100%;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Ice Shard */
        .ice-shard {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 15px solid #e0f2f7; /* Light blue */
            transform: rotate(var(--rotation, 0deg));
            box-shadow: 0 0 5px #e0f2f7, 0 0 10px var(--element-glow-color);
            animation: shard-float linear infinite;
        }

        /* Ice Sparkle */
        .ice-sparkle {
            width: 3px;
            height: 3px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 0 5px white, 0 0 10px #a7d9f2;
            animation: sparkle-fade 1.5s infinite ease-out;
        }

        @keyframes snowfall {
            0% { transform: translate3d(var(--x), 0, 0) rotate(0deg); opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { transform: translate3d(var(--x), 100vh, 0) rotate(720deg); opacity: 0; }
        }
        @keyframes shard-float {
            0% { transform: translate3d(var(--x), 0, 0) rotate(var(--rotation, 0deg)); opacity: 0; }
            5% { opacity: 0.8; }
            95% { opacity: 0.8; }
            100% { transform: translate3d(var(--x), 100vh, 0) rotate(calc(var(--rotation, 0deg) + 360deg)); opacity: 0; }
        }

        /* Fire Theme - Embers */
        .ember {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffeb3b 0%, #ff9800 70%, #f44336 100%); /* Yellow to red */
            box-shadow: 0 0 12px var(--element-glow-color), 0 0 20px rgba(255, 152, 0, 0.5);
            animation: fire-float ease-out infinite;
        }
        /* Flame Wisp */
        .flame-wisp {
            width: 10px;
            height: 20px;
            background: linear-gradient(to top, #ff4500, #ffa500, #ffeb3b);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            transform: rotate(var(--rotation, 0deg));
            box-shadow: 0 0 10px var(--element-glow-color);
            animation: flame-wisp-float ease-out infinite;
        }
        /* Smoke Puff */
        .smoke-puff {
            width: 25px;
            height: 25px;
            background-color: rgba(100, 100, 100, 0.1);
            border-radius: 50%;
            filter: blur(3px);
            animation: smoke-float ease-out infinite;
        }
        /* Fire Spark */
        .fire-spark {
            width: 2px;
            height: 2px;
            background-color: #ffeb3b;
            border-radius: 50%;
            box-shadow: 0 0 5px #ffeb3b, 0 0 10px #ff4500;
            animation: spark-flicker 1s infinite ease-out;
        }

        @keyframes fire-float {
            0% { transform: translateY(0) scale(0.6); opacity: 0; }
            20% { opacity: 0.8; transform: translateY(-20px) scale(1); }
            80% { opacity: 0.5; transform: translateY(-80px) scale(0.7); }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }
        @keyframes flame-wisp-float {
            0% { transform: translateY(0) rotate(var(--rotation, 0deg)); opacity: 0; }
            20% { opacity: 0.9; transform: translateY(-30px) rotate(var(--rotation, 0deg)); }
            80% { opacity: 0.6; transform: translateY(-100px) rotate(var(--rotation, 0deg)); }
            100% { transform: translateY(-120px) rotate(var(--rotation, 0deg)); opacity: 0; }
        }
        @keyframes smoke-float {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 0.3; transform: translateY(-10px) scale(0.8); }
            80% { opacity: 0.1; transform: translateY(-50px) scale(1.2); }
            100% { transform: translateY(-60px) scale(1.5); opacity: 0; }
        }

        /* Electric Theme - Lightning Sparks */
        .lightning-spark {
            width: 6px;
            height: 6px;
            background-color: #00ffff; /* Cyan */
            border-radius: 50%;
            box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 30px var(--element-glow-color);
            animation: spark-flicker ease-out infinite;
        }
        /* Electric Bolt (small jagged line) */
        .electric-bolt {
            width: 2px;
            height: 15px;
            background-color: #00ffff;
            transform: rotate(var(--rotation, 0deg));
            box-shadow: 0 0 10px #00ffff, 0 0 20px var(--element-glow-color);
            animation: bolt-flash 0.8s infinite ease-out;
        }
        /* Electric Orb (pulsating circle) */
        .electric-orb {
            width: 15px;
            height: 15px;
            background-color: #8a2be2; /* Blue Violet */
            border-radius: 50%;
            box-shadow: 0 0 15px #8a2be2, 0 0 30px var(--element-glow-color);
            animation: orb-pulse 2s infinite ease-in-out;
        }

        @keyframes spark-flicker {
            0%, 100% { transform: scale(0.5); opacity: 0; }
            10% { transform: scale(1.2); opacity: 1; }
            20% { transform: scale(0.7); opacity: 0.5; }
            30% { transform: scale(1.5); opacity: 1; }
            40%, 90% { transform: scale(0.8); opacity: 0; }
        }
        @keyframes bolt-flash {
            0%, 100% { opacity: 0; transform: scaleY(0.1) rotate(var(--rotation, 0deg)); }
            20% { opacity: 1; transform: scaleY(1) rotate(var(--rotation, 0deg)); }
            80% { opacity: 0.5; transform: scaleY(0.5) rotate(var(--rotation, 0deg)); }
        }
        @keyframes orb-pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Grass Theme - Leaves */
        .leaf {
            width: 20px;
            height: 10px;
            background-color: #8bc34a; /* Green */
            border-radius: 0 50% 50% 50% / 0 100% 100% 100%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            animation: leaf-fall linear infinite;
        }
        /* Grass Blade */
        .grass-blade {
            width: 3px;
            height: 25px;
            background-color: #6b8e23; /* Olive green */
            border-radius: 50% 50% 0 0;
            transform: rotate(var(--rotation, 0deg));
            animation: grass-sway linear infinite;
        }
        /* Flower Petal */
        .flower-petal {
            width: 8px;
            height: 8px;
            background-color: #ffc0cb; /* Light pink */
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 192, 203, 0.5);
            animation: petal-float linear infinite;
        }
        /* Dewdrop */
        .dewdrop {
            width: 5px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.2);
            animation: dewdrop-fall linear infinite;
        }

        @keyframes leaf-fall {
            0% { transform: translate3d(var(--x), 0, 0) rotateZ(0deg) rotateX(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translate3d(var(--x), 100vh, 0) rotateZ(720deg) rotateX(360deg); opacity: 0; }
        }
        @keyframes grass-sway {
            0%, 100% { transform: translateY(0) rotate(var(--rotation, 0deg)); opacity: 0.8; }
            50% { transform: translateY(-5px) rotate(calc(var(--rotation, 0deg) + 5deg)); opacity: 1; }
        }
        @keyframes petal-float {
            0% { transform: translate3d(var(--x), 0, 0) rotate(0deg); opacity: 0; }
            5% { opacity: 0.9; }
            95% { opacity: 0.9; }
            100% { transform: translate3d(var(--x), 100vh, 0) rotate(360deg); opacity: 0; }
        }
        @keyframes dewdrop-fall {
            0% { transform: translate3d(var(--x), 0, 0); opacity: 0; }
            5% { opacity: 0.7; }
            95% { opacity: 0.7; }
            100% { transform: translate3d(var(--x), 100vh, 0); opacity: 0; }
        }

        /* Candy Theme - Cute & Pink */
        .candy-shape {
            opacity: 0.8;
            animation: candy-float 15s infinite ease-in-out;
            filter: drop-shadow(0 0 5px rgba(255, 105, 180, 0.4));
        }

        .candy-heart {
            width: 20px;
            height: 18px;
            background-color: #ff69b4; /* Hot pink */
            position: relative;
            transform: rotate(-45deg);
        }
        .candy-heart::before,
        .candy-heart::after {
            content: '';
            width: 20px;
            height: 20px;
            position: absolute;
            border-radius: 50%;
            background-color: #ff69b4;
        }
        .candy-heart::before {
            top: -10px;
            left: 0;
        }
        .candy-heart::after {
            top: 0;
            left: 10px;
        }

        .candy-star {
            width: 0;
            height: 0;
            border-right: 10px solid transparent;
            border-left: 10px solid transparent;
            border-bottom: 7px solid #ffe4e1; /* Pastel pink */
            position: relative;
        }
        .candy-star::before {
            content: '';
            width: 0;
            height: 0;
            border-right: 10px solid transparent;
            border-left: 10px solid transparent;
            border-top: 7px solid #ffe4e1;
            position: absolute;
            top: 3px;
            left: -10px;
        }

        .candy-lollipop {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff69b4 0%, #ffc0cb 50%, #f0f8ff 100%);
            position: relative;
            box-shadow: 0 0 8px rgba(255, 105, 180, 0.5);
        }
        .candy-lollipop::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 8px;
            width: 4px;
            height: 15px;
            background-color: #d2b48c; /* Stick color */
            border-radius: 2px;
        }

        @keyframes candy-float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
            25% { transform: translateY(-15px) rotate(5deg); opacity: 0.9; }
            50% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
            75% { transform: translateY(-10px) rotate(-3deg); opacity: 0.9; }
        }

        /* For sparkles */
        .candy-sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 0 5px white, 0 0 10px #ffc0cb;
            opacity: 0;
            animation: sparkle-fade 1.5s infinite ease-out;
        }

        @keyframes sparkle-fade {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }
    </style>
</head>
<body>
  <!-- Particle Toggle Switch and Mode Selection -->
  <div class="particle-switch-container">
      <div class="particle-control-group">
          <label for="particle-toggle">背景动画开关</label>
          <label class="switch">
              <input type="checkbox" id="particle-toggle" checked>
              <span class="slider"></span>
          </label>
      </div>
      <div class="radio-group">
          <input type="radio" id="mouse-mode-particles" name="mouse-mode" value="particles" checked>
          <label for="mouse-mode-particles">粒子模式</label>
          <input type="radio" id="mouse-mode-lines" name="mouse-mode" value="lines">
          <label for="mouse-mode-lines">线条模式</label>
      </div>
  </div>

  <!-- Geometric background -->
  <div class="geometric-bg" id="geometric-bg"></div>

  <!-- Enhanced particles -->
  <div class="particles" id="particles"></div>

  <!-- Element Specific Decorations -->
  <div id="element-decorations"></div>

  <!-- Techy Mouse Particle Canvas -->
  <canvas id="mouse-particle-canvas"></canvas>

  <div class="container" id="main-container">
    <div class="header">
        <span>✨ 解析lora元数据 ✨</span>
        <div class="controls-section">
            <div class="theme-selector">
                <div class="theme-btn active" data-theme="dark" title="深色主题"></div>
                <div class="theme-btn" data-theme="light" title="浅色主题"></div>
                <div class="theme-btn" data-theme="blue" title="蓝色主题"></div>
                <div class="theme-btn" data-theme="purple" title="紫色主题"></div>
                <div class="theme-btn" data-theme="green" title="绿色主题"></div>
                <div class="theme-btn" data-theme="orange" title="橙色主题"></div>
            </div>
            <div class="bg-selector">
                <div class="bg-btn" data-bg="ice" title="冰雪主题"></div>
                <div class="bg-btn" data-bg="fire" title="火焰主题"></div>
                <div class="bg-btn" data-bg="electric" title="闪电主题"></div>
                <div class="bg-btn" data-bg="grass" title="草原主题"></div>
                <div class="bg-btn" data-bg="candy" title="糖果主题"></div>
            </div>
        </div>
    </div>
    
    <div id="link-input-section">
        <input type="text" id="civitai-url-input" placeholder="🔗 粘贴 Civitai 模型或版本链接到这里...">
        <button id="parse-link-btn">🔍 解析链接</button>
        <button id="download-lora-btn" class="hidden">⬇️ 下载 LoRA</button>
    </div>

    <div id="dropArea">
      <p>将 .safetensors 文件拖拽到此处</p>
    </div>
    
    <div id="loading"><div class="loading-message"></div><div class="spinner"></div></div>

    <div id="resultsPanel" class="hidden">
      
      <div id="civitaiPanel" class="panel hidden">
        <h3>
            <span>🌐 Civitai 信息</span>
            <button id="export-triggers-btn" class="action-button hidden">📄 导出触发词</button>
        </h3>
        <dl class="info-grid">
          <dt>模型名称</dt><dd id="civitai-model-name">-</dd>
          <dt>创作者</dt><dd id="civitai-creator">-</dd>
          <dt>触发词</dt><dd id="civitai-trained-words" class="tag-container"></dd>
          <dt>基础模型</dt><dd id="civitai-base-model">-</dd>
          <dt>Civitai 链接</dt><dd><a id="civitai-link" href="#" target="_blank">🔗 点击查看</a></dd>
        </dl>
        <div id="image-viewer" class="hidden">
            <img id="civitai-preview-image" alt="Civitai Preview Image">
            <div id="image-nav" class="hidden">
                <button id="prev-image-btn">⬅️ 上一张</button>
                <span id="image-counter"></span>
                <button id="next-image-btn">➡️ 下一张</button>
                <button id="export-image-btn" class="action-button">🖼️ 导出图片</button>
            </div>
        </div>
      </div>

      <div id="trainingDetailsPanel" class="panel hidden">
        <h3>🎯 训练详情</h3>
        <dl class="info-grid">
            <dt>算法 (Algorithm)</dt><dd id="details-algo">-</dd>
            <dt>学习率 (LR)</dt><dd id="details-lr">-</dd>
            <dt>优化器 (Optimizer)</dt><dd id="details-optimizer">-</dd>
            <dt>图片总数</dt><dd id="details-total-images">-</dd>
            <dt>Resource Info</dt><dd><a id="details-resource-info" href="#" target="_blank">🔗 查看资源</a></dd>
        </dl>
      </div>
      
      <div id="descriptionPanel" class="panel hidden">
        <h3>
            <span>📝 模型介绍 & 版本信息</span>
            <button id="export-log-btn" class="action-button">💾 导出介绍</button>
        </h3>
        <h4>📖 模型介绍 (Description)</h4>
        <div id="civitai-description" class="description-content"></div>
        <h4 style="margin-top: 20px;">ℹ️ 版本信息 (Version Info)</h4>
        <div id="civitai-version-info" class="description-content"></div>
      </div>

      <div id="editorPanel" class="panel hidden">
        <h3>⚙️ 元数据编辑器</h3>
        <textarea id="metadata-editor-textarea"></textarea>
        <div id="editor-actions">
            <button id="update-lora-button">🔄 更新并下载 LoRA</button>
        </div>
      </div>

      <div id="metadataPanel" class="panel hidden">
        <h3>📊 文件元数据 (原始)</h3>
        <pre id="metadataDisplay"></pre>
      </div>

    </div>
  </div>

  <script>
    // --- Utility Functions ---
    function hexToRgb(hex) {
        const bigint = parseInt(hex.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `${r}, ${g}, ${b}`;
    }

    // --- Techy Mouse Effect System (Canvas) ---
    const canvas = document.getElementById('mouse-particle-canvas');
    const ctx = canvas.getContext('2d');
    let particles = []; // For particle mode
    let mouseTrail = []; // For line mode
    const maxTrailLength = 50; // Max points in mouse trail
    const trailFadeTime = 500; // Milliseconds for a trail segment to fade
    let mouse = { x: null, y: null };
    let particleToggleEnabled = true;
    let mouseEffectMode = 'particles'; // 'particles' or 'lines'

    // Pre-calculated colors for performance
    let currentMouseParticleColorRgb = '0, 255, 255'; // Default cyan
    let currentMouseLineColorRgb = '0, 255, 255'; // Default cyan
    let currentElementGlowColorRgb = '74, 171, 247'; // Default from dark theme glow

    function updateThemeColorsForCanvas() {
        const rootStyle = getComputedStyle(document.documentElement);
        const mouseParticleHex = rootStyle.getPropertyValue('--mouse-particle-color').trim();
        const mouseLineHex = rootStyle.getPropertyValue('--mouse-line-color').trim();
        const elementGlowHex = rootStyle.getPropertyValue('--element-glow-color').trim();

        currentMouseParticleColorRgb = hexToRgb(mouseParticleHex);
        currentMouseLineColorRgb = hexToRgb(mouseLineHex);
        currentElementGlowColorRgb = hexToRgb(elementGlowHex.startsWith('rgba') ? 'transparent' : elementGlowHex); // Extract hex if not rgba
    }

    // Resize canvas on window resize
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); // Initial resize
    updateThemeColorsForCanvas(); // Initial color update

    // Update mouse coordinates and generate effect data
    document.addEventListener('mousemove', (e) => {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
        if (!particleToggleEnabled) return;

        if (mouseEffectMode === 'particles') {
            for (let i = 0; i < 2; i++) { // Generate a few particles per mouse move
                particles.push(new Particle(mouse.x, mouse.y, currentMouseParticleColorRgb));
            }
        } else if (mouseEffectMode === 'lines') {
            mouseTrail.push({ 
                x: mouse.x, 
                y: mouse.y, 
                timestamp: Date.now(), 
                color: currentMouseLineColorRgb,
                glow: currentElementGlowColorRgb // Use element glow for lines
            });
            // Keep trail length under control
            if (mouseTrail.length > maxTrailLength) {
                mouseTrail.splice(0, mouseTrail.length - maxTrailLength);
            }
        }
    });

    // Particle class for 'particles' mode
    class Particle {
        constructor(x, y, colorRgb) {
            this.x = x;
            this.y = y;
            this.size = Math.random() * 5 + 1; // Varying size
            this.speedX = Math.random() * 2 - 1; // -1 to 1
            this.speedY = Math.random() * 2 - 1; // -1 to 1
            this.colorRgb = colorRgb;
            this.opacity = 1;
            this.life = 100; // Frames to live
        }

        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.opacity -= 0.01; // Fade out
            this.life--;
            if (this.size > 0.2) this.size -= 0.1; // Shrink
        }

        draw() {
            ctx.fillStyle = `rgba(${this.colorRgb}, ${this.opacity})`;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = `rgba(${this.colorRgb}, ${this.opacity * 0.8})`;
            ctx.fillStyle = `rgba(${this.colorRgb}, ${this.opacity * 0.5})`;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0; // Reset shadow
        }
    }

    // Animation loop for both mouse effects
    function animateMouseEffect() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (!particleToggleEnabled) {
            particles = [];
            mouseTrail = [];
            requestAnimationFrame(animateMouseEffect);
            return;
        }

        if (mouseEffectMode === 'particles') {
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].life <= 0 || particles[i].size <= 0.2 || particles[i].opacity <= 0.01) {
                    particles.splice(i, 1);
                }
            }
        } else if (mouseEffectMode === 'lines') {
            const currentTime = Date.now();
            // Filter out old trail points
            mouseTrail = mouseTrail.filter(point => currentTime - point.timestamp < trailFadeTime * 2);

            if (mouseTrail.length > 1) {
                ctx.lineWidth = 2; // Default line width
                ctx.lineCap = 'round';
                
                for (let i = 0; i < mouseTrail.length - 1; i++) {
                    const p1 = mouseTrail[i];
                    const p2 = mouseTrail[i+1];
                    const age1 = currentTime - p1.timestamp;
                    const opacity = Math.max(0, 1 - (age1 / trailFadeTime));
                    const lineWidth = Math.max(0.5, 2 - (age1 / trailFadeTime));

                    ctx.strokeStyle = `rgba(${p1.color}, ${opacity})`;
                    ctx.lineWidth = lineWidth;

                    ctx.beginPath();
                    if (activeElementTheme === 'electric') {
                        // Lightning effect for Electric theme
                        const maxOffset = 10;
                        ctx.moveTo(p1.x + (Math.random() - 0.5) * maxOffset, p1.y + (Math.random() - 0.5) * maxOffset);
                        ctx.lineTo(p2.x + (Math.random() - 0.5) * maxOffset, p2.y + (Math.random() - 0.5) * maxOffset);
                        ctx.shadowBlur = 25;
                        ctx.shadowColor = `rgba(${p1.glow}, ${opacity * 1.5})`; // Stronger glow for lightning
                        ctx.stroke();

                        // Add smaller, faint branching lightning for more effect
                        if (Math.random() > 0.7) {
                            ctx.beginPath();
                            const branchLength = Math.random() * 20 + 10;
                            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                            const branchAngle = angle + (Math.random() - 0.5) * Math.PI / 3; // Random angle offset
                            ctx.moveTo(p2.x, p2.y);
                            ctx.lineTo(p2.x + branchLength * Math.cos(branchAngle), p2.y + branchLength * Math.sin(branchAngle));
                            ctx.lineWidth = lineWidth * 0.7;
                            ctx.strokeStyle = `rgba(${p1.color}, ${opacity * 0.7})`;
                            ctx.stroke();
                        }
                    } else {
                        // Regular line trail
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = `rgba(${p1.glow}, ${opacity * 0.8})`;
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                    }
                    ctx.shadowBlur = 0; // Reset shadow after drawing
                }
            }
        }
        requestAnimationFrame(animateMouseEffect);
    }

    // Start animation loop
    animateMouseEffect();

    // Toggle particle effect
    const particleToggle = document.getElementById('particle-toggle');
    particleToggle.addEventListener('change', () => {
        particleToggleEnabled = particleToggle.checked;
    });

    // Mouse effect mode radio buttons
    document.querySelectorAll('input[name="mouse-mode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            mouseEffectMode = e.target.value;
            particles = []; // Clear particles if switching to lines
            mouseTrail = []; // Clear trail if switching to particles
        });
    });


    // --- Enhanced Particle System (Background) ---
    function createParticles() {
        const particlesContainer = document.getElementById('particles');
        // Clear existing particles to regenerate with new theme colors
        particlesContainer.innerHTML = ''; 

        const particleTypes = ['particle-small', 'particle-medium', 'particle-large', 'particle-glow'];
        const particleCount = 40; 
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            const type = particleTypes[Math.floor(Math.random() * particleTypes.length)];
            particle.className = `particle ${type}`;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (Math.random() * 15 + 15) + 's';
            particlesContainer.appendChild(particle);
        }
    }

    // --- Geometric Shapes System (Background) ---
    function createGeometricShapes() {
        const geometricContainer = document.getElementById('geometric-bg');
        // Clear existing shapes to regenerate with new theme colors
        geometricContainer.innerHTML = ''; 

        const shapes = ['triangle', 'circle', 'square', 'hexagon'];
        const shapeCount = 25; 
        
        for (let i = 0; i < shapeCount; i++) {
            const shape = document.createElement('div');
            const shapeType = shapes[Math.floor(Math.random() * shapes.length)];
            shape.className = `geometric-shape shape-${shapeType}`;
            shape.style.left = Math.random() * 100 + '%';
            shape.style.animationDelay = Math.random() * 25 + 's';
            shape.style.animationDuration = (Math.random() * 20 + 20) + 's';
            geometricContainer.appendChild(shape);
        }
    }

    // --- Element Specific Decorations ---
    const elementDecorationsContainer = document.getElementById('element-decorations');

    function createElementDecorations(theme) {
        elementDecorationsContainer.innerHTML = ''; // Clear existing decorations
        const baseCount = 60; // Base number of decorations
        
        switch (theme) {
            case 'ice':
                for (let i = 0; i < baseCount; i++) {
                    const type = Math.random();
                    let element;
                    if (type < 0.5) {
                        element = document.createElement('div');
                        element.className = 'decoration-element snowflake';
                    } else if (type < 0.8) {
                        element = document.createElement('div');
                        element.className = 'decoration-element ice-shard';
                        element.style.setProperty('--rotation', `${Math.random() * 360}deg`);
                    } else {
                        element = document.createElement('div');
                        element.className = 'decoration-element ice-sparkle';
                    }
                    element.style.left = Math.random() * 100 + '%';
                    element.style.setProperty('--x', `${(Math.random() - 0.5) * 200}px`); // Horizontal drift
                    element.style.animationDuration = (Math.random() * 15 + 10) + 's';
                    element.style.animationDelay = (Math.random() * 10) + 's';
                    elementDecorationsContainer.appendChild(element);
                }
                break;
            case 'fire':
                for (let i = 0; i < baseCount; i++) {
                    const type = Math.random();
                    let element;
                    if (type < 0.4) {
                        element = document.createElement('div');
                        element.className = 'decoration-element ember';
                    } else if (type < 0.7) {
                        element = document.createElement('div');
                        element.className = 'decoration-element flame-wisp';
                        element.style.setProperty('--rotation', `${(Math.random() - 0.5) * 40}deg`);
                    } else if (type < 0.9) {
                        element = document.createElement('div');
                        element.className = 'decoration-element smoke-puff';
                    } else {
                        element = document.createElement('div');
                        element.className = 'decoration-element fire-spark';
                    }
                    element.style.left = Math.random() * 100 + '%';
                    element.style.top = (80 + Math.random() * 20) + '%'; // Start near bottom
                    element.style.animationDuration = (Math.random() * 5 + 3) + 's';
                    element.style.animationDelay = (Math.random() * 3) + 's';
                    elementDecorationsContainer.appendChild(element);
                }
                break;
            case 'electric':
                for (let i = 0; i < baseCount * 1.5; i++) { // More for electric
                    const type = Math.random();
                    let element;
                    if (type < 0.4) {
                        element = document.createElement('div');
                        element.className = 'decoration-element lightning-spark';
                    } else if (type < 0.7) {
                        element = document.createElement('div');
                        element.className = 'decoration-element electric-bolt';
                        element.style.setProperty('--rotation', `${Math.random() * 360}deg`);
                    } else {
                        element = document.createElement('div');
                        element.className = 'decoration-element electric-orb';
                    }
                    element.style.left = Math.random() * 100 + '%';
                    element.style.top = Math.random() * 100 + '%';
                    element.style.animationDuration = (Math.random() * 2 + 0.5) + 's';
                    element.style.animationDelay = (Math.random() * 2) + 's';
                    elementDecorationsContainer.appendChild(element);
                }
                break;
            case 'grass':
                for (let i = 0; i < baseCount; i++) {
                    const type = Math.random();
                    let element;
                    if (type < 0.4) {
                        element = document.createElement('div');
                        element.className = 'decoration-element leaf';
                        element.style.setProperty('--x', `${(Math.random() - 0.5) * 150}px`); // Horizontal drift
                    } else if (type < 0.7) {
                        element = document.createElement('div');
                        element.className = 'decoration-element grass-blade';
                        element.style.setProperty('--rotation', `${(Math.random() - 0.5) * 30}deg`);
                    } else if (type < 0.9) {
                        element = document.createElement('div');
                        element.className = 'decoration-element flower-petal';
                        element.style.setProperty('--x', `${(Math.random() - 0.5) * 100}px`);
                    } else {
                        element = document.createElement('div');
                        element.className = 'decoration-element dewdrop';
                        element.style.setProperty('--x', `${(Math.random() - 0.5) * 50}px`);
                    }
                    element.style.left = Math.random() * 100 + '%';
                    element.style.animationDuration = (Math.random() * 10 + 7) + 's';
                    element.style.animationDelay = (Math.random() * 5) + 's';
                    elementDecorationsContainer.appendChild(element);
                }
                break;
            case 'candy':
                const candyShapes = ['candy-heart', 'candy-star', 'candy-lollipop'];
                for (let i = 0; i < baseCount; i++) {
                    const shapeType = candyShapes[Math.floor(Math.random() * candyShapes.length)];
                    const candy = document.createElement('div');
                    candy.className = `decoration-element ${shapeType} candy-shape`;
                    candy.style.left = Math.random() * 100 + '%';
                    candy.style.top = Math.random() * 100 + '%';
                    candy.style.animationDuration = (Math.random() * 15 + 10) + 's';
                    candy.style.animationDelay = (Math.random() * 10) + 's';
                    elementDecorationsContainer.appendChild(candy);
                }
                // Add more sparkles for candy theme
                for (let i = 0; i < 50; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'decoration-element candy-sparkle';
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    sparkle.style.animationDuration = (Math.random() * 2 + 1) + 's';
                    sparkle.style.animationDelay = (Math.random() * 2) + 's';
                    elementDecorationsContainer.appendChild(sparkle);
                }
                break;
        }
    }


    // --- Ripple Effect ---
    function createRipple(e) {
        const button = e.currentTarget;
        const rect = button.getBoundingClientRect();
        const ripple = document.createElement('span');
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.className = 'ripple';
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        
        button.appendChild(ripple);
        
        setTimeout(() => {
            if (ripple.parentNode) {
                ripple.parentNode.removeChild(ripple);
            }
        }, 600);
    }

    // --- Theme Management ---
    const themeButtons = document.querySelectorAll('.theme-btn');
    const bgButtons = document.querySelectorAll('.bg-btn');
    const root = document.documentElement;

    let activeUITheme = 'dark';
    let activeElementTheme = null; // No element theme active by default

    // Set initial UI theme
    setTheme(activeUITheme);

    themeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            createRipple(e);
            const theme = btn.dataset.theme;
            if (activeUITheme !== theme) {
                setTheme(theme);
                // Deactivate all background buttons when a UI theme is selected
                bgButtons.forEach(b => b.classList.remove('active'));
                activeElementTheme = null;
                // Reset element specific styles to UI theme defaults
                root.style.setProperty('--element-bg', getComputedStyle(document.documentElement).getPropertyValue('--ui-bg'));
                root.style.setProperty('--element-particle-color', getComputedStyle(document.documentElement).getPropertyValue('--ui-accent-color'));
                root.style.setProperty('--element-glow-color', getComputedStyle(document.documentElement).getPropertyValue('--ui-glow-color'));
                root.style.setProperty('--mouse-particle-color', 'cyan'); // Default techy mouse particle color
                root.style.setProperty('--mouse-line-color', 'cyan');
                root.style.setProperty('--mouse-line-glow', 'rgba(0, 255, 255, 0.5)');
                
                updateThemeColorsForCanvas();
                createParticles(); // Recreate background particles with UI theme defaults
                createGeometricShapes(); // Recreate geometric shapes with UI theme defaults
                elementDecorationsContainer.innerHTML = ''; // Clear specific element decorations
            }
        });
    });

    bgButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            createRipple(e);
            const bg = btn.dataset.bg;
            if (activeElementTheme !== bg) {
                setBackground(bg);
                // Deactivate all UI theme buttons when an element theme is selected
                themeButtons.forEach(t => t.classList.remove('active'));
                activeUITheme = null; // No UI theme explicitly selected now
            }
        });
    });

    function setTheme(theme) {
        root.setAttribute('data-theme', theme);
        themeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
        activeUITheme = theme;
        updateThemeColorsForCanvas(); // Update canvas colors when UI theme changes
    }

    function setBackground(bg) {
        bgButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.bg === bg);
        });
        activeElementTheme = bg;

        let customBgValue;
        let particleColor;
        let glowColor;
        let mouseParticleColor = 'cyan'; // Default techy mouse particle color
        let mouseLineColor = 'cyan';
        let mouseLineGlow = 'rgba(0, 255, 255, 0.5)';

        switch (bg) {
            case 'ice':
                customBgValue = 'linear-gradient(135deg, #e0f2f7 0%, #a7d9f2 100%)';
                particleColor = '#81d4fa'; // Light blue
                glowColor = 'rgba(129, 212, 250, 0.5)';
                mouseParticleColor = '#00ffff'; // Cyan for techy
                mouseLineColor = '#00ffff';
                mouseLineGlow = 'rgba(0, 255, 255, 0.7)';
                break;
            case 'fire':
                customBgValue = 'linear-gradient(135deg, #ff8c00 0%, #ff4500 100%)';
                particleColor = '#ffb300'; // Amber
                glowColor = 'rgba(255, 179, 0, 0.5)';
                mouseParticleColor = '#ff6600'; // Orange for techy
                mouseLineColor = '#ff6600';
                mouseLineGlow = 'rgba(255, 102, 0, 0.7)';
                break;
            case 'electric':
                customBgValue = 'linear-gradient(135deg, #4d0080 0%, #8a2be2 100%)';
                particleColor = '#9c27b0'; // Deep purple
                glowColor = 'rgba(156, 39, 176, 0.5)';
                mouseParticleColor = '#9aff00'; // Lime green for techy electric sparks
                mouseLineColor = '#9aff00'; // Electric green for lightning
                mouseLineGlow = 'rgba(154, 255, 0, 0.9)'; // Intense glow for lightning
                break;
            case 'grass':
                customBgValue = 'linear-gradient(135deg, #aed581 0%, #8bc34a 100%)';
                particleColor = '#7cb342'; // Green
                glowColor = 'rgba(124, 179, 66, 0.5)';
                mouseParticleColor = '#00dd00'; // Bright green for techy nature
                mouseLineColor = '#00dd00';
                mouseLineGlow = 'rgba(0, 221, 0, 0.7)';
                break;
            case 'candy':
                customBgValue = 'linear-gradient(135deg, #ffe0f0 0%, #ffc0cb 100%)'; // Soft pink to light pink
                particleColor = '#ff69b4'; // Hot pink
                glowColor = 'rgba(255, 105, 180, 0.6)'; // Stronger pink glow
                mouseParticleColor = '#ff1493'; // Deep pink for techy
                mouseLineColor = '#ff1493';
                mouseLineGlow = 'rgba(255, 20, 147, 0.8)';
                break;
            default: // Fallback if no specific element theme is active
                customBgValue = getComputedStyle(document.documentElement).getPropertyValue('--ui-bg');
                particleColor = getComputedStyle(document.documentElement).getPropertyValue('--ui-accent-color');
                glowColor = getComputedStyle(document.documentElement).getPropertyValue('--ui-glow-color');
                mouseParticleColor = 'cyan';
                mouseLineColor = 'cyan';
                mouseLineGlow = 'rgba(0, 255, 255, 0.5)';
                break;
        }

        root.style.setProperty('--element-bg', customBgValue);
        root.style.setProperty('--element-particle-color', particleColor);
        root.style.setProperty('--element-glow-color', glowColor);
        root.style.setProperty('--mouse-particle-color', mouseParticleColor);
        root.style.setProperty('--mouse-line-color', mouseLineColor);
        root.style.setProperty('--mouse-line-glow', mouseLineGlow);

        updateThemeColorsForCanvas(); // Update canvas colors when element theme changes
        createParticles(); // Re-create existing particles to pick up new colors
        createGeometricShapes(); // Re-create geometric shapes to pick up new colors
        createElementDecorations(bg); // Create element-specific decorations
    }

    // Initialize effects (ensure they use current theme/background)
    // Initially, only UI theme 'dark' is active, no element theme selected.
    // The background and particles will default to the UI theme's colors.
    createParticles();
    createGeometricShapes();
    // No specific element decorations initially.

    // Add ripple effect to all buttons
    document.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.classList.contains('theme-btn') || e.target.classList.contains('bg-btn')) {
            createRipple(e);
        }
    });

    // --- DOM Element References ---
    const urlInput = document.getElementById('civitai-url-input');
    const parseLinkBtn = document.getElementById('parse-link-btn');
    const downloadLoraBtn = document.getElementById('download-lora-btn');
    const dropArea = document.getElementById('dropArea');
    const loadingDiv = document.getElementById('loading');
    const loadingMessage = document.querySelector('.loading-message');
    const resultsPanel = document.getElementById('resultsPanel');
    const civitaiPanel = document.getElementById('civitaiPanel');
    const descriptionPanel = document.getElementById('descriptionPanel');
    const trainingDetailsPanel = document.getElementById('trainingDetailsPanel');
    const metadataPanel = document.getElementById('metadataPanel');
    const editorPanel = document.getElementById('editorPanel');
    const metadataDisplay = document.getElementById('metadataDisplay');
    const metadataEditorTextarea = document.getElementById('metadata-editor-textarea');
    const updateLoraButton = document.getElementById('update-lora-button');
    const imageViewer = document.getElementById('image-viewer');
    const previewImage = document.getElementById('civitai-preview-image');
    const imageNav = document.getElementById('image-nav');
    const prevBtn = document.getElementById('prev-image-btn');
    const nextBtn = document.getElementById('next-image-btn');
    const imageCounter = document.getElementById('image-counter');
    const trainedWordsDd = document.getElementById('civitai-trained-words');
    const exportLogBtn = document.getElementById('export-log-btn');
    const exportTriggersBtn = document.getElementById('export-triggers-btn');
    const exportImageBtn = document.getElementById('export-image-btn');

    // --- State Variables ---
    let currentImageIndex = 0;
    let imageUrls = [];
    let currentLoraFile = null;
    let currentCivitaiData = null;

    // --- Event Listeners ---
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.safetensors';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => handleFileSelect(fileInput.files[0]));
    dropArea.addEventListener('drop', e => handleFileSelect(e.dataTransfer.files[0]), false);
    
    parseLinkBtn.addEventListener('click', handleLinkParse);
    downloadLoraBtn.addEventListener('click', downloadLoraFromLink);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.add('hover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.remove('hover'), false);
    });
    
    prevBtn.addEventListener('click', showPreviousImage);
    nextBtn.addEventListener('click', showNextImage);
    exportLogBtn.addEventListener('click', exportDescription);
    exportTriggersBtn.addEventListener('click', exportTriggerWords);
    exportImageBtn.addEventListener('click', exportCurrentImage);
    updateLoraButton.addEventListener('click', updateAndDownloadLora);

    // --- Main Handlers ---
    function handleFileSelect(file) {
        if (!file || !file.name.endsWith('.safetensors')) {
            alert('请提供一个有效的 .safetensors 文件。');
            return;
        }
        currentLoraFile = file;
        urlInput.value = '';
        processLora();
    }
    
    async function handleLinkParse() {
        const url = urlInput.value.trim();
        if (!url) {
            alert('请输入一个Civitai链接。');
            return;
        }
        const match = url.match(/civitai\.com\/models\/(\d+)(?:\S*modelVersionId=(\d+))?/);
        if (!match) {
            alert('链接格式无效，请输入一个有效的Civitai模型或版本链接。');
            return;
        }
        const modelId = match[1];
        const versionId = match[2];

        clearResults();
        showLoading('正在通过链接解析...');

        try {
            let civitaiData;
            if (versionId) {
                civitaiData = await fetchCivitaiDataById(versionId, 'version');
            } else {
                const modelData = await fetchCivitaiDataById(modelId, 'model');
                if (modelData && modelData.modelVersions && modelData.modelVersions.length > 0) {
                    civitaiData = await fetchCivitaiDataById(modelData.modelVersions[0].id, 'version');
                }
            }

            if (civitaiData) {
                currentCivitaiData = civitaiData;
                metadataPanel.classList.add('hidden');
                trainingDetailsPanel.classList.add('hidden');
                editorPanel.classList.add('hidden');
                
                displayCivitaiData(civitaiData);
                civitaiPanel.classList.remove('hidden');
                descriptionPanel.classList.remove('hidden');
                resultsPanel.classList.remove('hidden');
                downloadLoraBtn.classList.remove('hidden');
            } else {
                alert('无法从链接获取信息，请检查链接或稍后再试。');
            }
        } catch(error) {
            console.error('通过链接解析时发生错误:', error);
            alert(`通过链接解析时发生错误: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    async function processLora() {
      showLoading('正在处理文件...');
      try {
        const metadata = await parseSafetensorsMetadata(currentLoraFile);
        showLoading('正在计算哈希值...');
        const hash = await calculateFileHash(currentLoraFile);
        const shortHash = hash.substring(0, 10);
        showLoading('正在查询 Civitai...');
        const civitaiData = await fetchCivitaiDataByHash(shortHash);
        currentCivitaiData = civitaiData;

        if (metadata) {
            displayInternalMetadata(metadata, shortHash);
            metadataPanel.classList.remove('hidden');
            trainingDetailsPanel.classList.remove('hidden');
            editorPanel.classList.remove('hidden');
        }
        if (civitaiData) {
          displayCivitaiData(civitaiData);
          civitaiPanel.classList.remove('hidden');
          descriptionPanel.classList.remove('hidden');
        }
        resultsPanel.classList.remove('hidden');
      } catch (error) {
        console.error('处理文件时发生错误:', error);
        alert(`处理文件时发生错误: ${error.message}`);
      } finally {
        hideLoading();
      }
    }
    
    // --- UI Update & Display Functions ---
    function showLoading(message) {
        loadingMessage.textContent = message;
        loadingDiv.style.display = 'block';
    }

    function hideLoading() {
        loadingDiv.style.display = 'none';
    }

    function clearResults() {
        resultsPanel.classList.add('hidden');
        civitaiPanel.classList.add('hidden');
        descriptionPanel.classList.add('hidden');
        trainingDetailsPanel.classList.add('hidden');
        metadataPanel.classList.add('hidden');
        editorPanel.classList.add('hidden');
        imageViewer.classList.add('hidden');
        imageNav.classList.add('hidden');
        exportTriggersBtn.classList.add('hidden');
        downloadLoraBtn.classList.add('hidden');
        imageUrls = [];
        currentImageIndex = 0;
        currentLoraFile = null;
        currentCivitaiData = null;
    }

    function displayInternalMetadata(metadata, hash) {
        const coloredJson = JSON.stringify(metadata, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;');
        metadataDisplay.innerHTML = coloredJson;
        metadataEditorTextarea.value = JSON.stringify(metadata, null, 2);
        
        const networkArgs = metadata.ss_network_args ? JSON.parse(metadata.ss_network_args) : {};
        document.getElementById('details-algo').textContent = networkArgs.algo || '未知';
        document.getElementById('details-lr').textContent = metadata.ss_learning_rate || '未知';
        document.getElementById('details-optimizer').textContent = metadata.ss_optimizer_type || (metadata.ss_optimizer || '').split('(')[0].trim() || '未知';
        let totalImages = 0;
        if (metadata.ss_dataset_dirs) {
            try {
                const datasets = JSON.parse(metadata.ss_dataset_dirs);
                totalImages = Object.values(datasets).reduce((sum, dir) => sum + (dir.img_count || 0), 0);
            } catch(e) { console.error("无法解析ss_dataset_dirs"); }
        }
        document.getElementById('details-total-images').textContent = totalImages > 0 ? totalImages : '未知';
        const resourceLink = document.getElementById('details-resource-info');
        const resourceUrl = `https://civitai.com/api/v1/model-versions/by-hash/${hash}`;
        resourceLink.href = resourceUrl;
        resourceLink.textContent = resourceUrl;
    }
    
    function displayCivitaiData(data) {
        document.getElementById('civitai-model-name').textContent = data.model?.name || '未知';
        document.getElementById('civitai-creator').textContent = data.model?.creator?.username || '未知';
        document.getElementById('civitai-base-model').textContent = data.baseModel || '未知';
        
        trainedWordsDd.innerHTML = ''; 
        const words = data.trainedWords;
        if (words && words.length > 0) {
            words.forEach(word => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = word;
                tag.onclick = (e) => copyToClipboard(word, e.target);
                trainedWordsDd.appendChild(tag);
            });
            const copyAll = document.createElement('button');
            copyAll.className = 'action-button copy-all-btn';
            copyAll.textContent = '📋 复制全部';
            copyAll.onclick = (e) => copyToClipboard(words.join(', '), e.target);
            trainedWordsDd.appendChild(copyAll);
            exportTriggersBtn.classList.remove('hidden');
        } else {
            trainedWordsDd.textContent = '无';
            exportTriggersBtn.classList.add('hidden');
        }

        const link = document.getElementById('civitai-link');
        const modelUrl = `https://civitai.com/models/${data.modelId}?modelVersionId=${data.id}`;
        link.href = modelUrl;
        link.textContent = '🔗 在 Civitai.com 上查看';
        
        document.getElementById('civitai-description').innerHTML = data.model?.description || '无';
        document.getElementById('civitai-version-info').innerHTML = data.description || '无';

        if (data.images && data.images.length > 0) {
            imageUrls = data.images.map(img => img.url);
            currentImageIndex = 0;
            updateImageViewer();
            imageViewer.classList.remove('hidden');
        }
    }
    
    // --- Feature Functions ---
    function copyToClipboard(text, element) {
        if (text && text !== '无' && text !== '-') {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.textContent;
                element.textContent = '✅ 复制成功!';
                element.classList.add('copy-success');
                setTimeout(() => {
                    element.textContent = originalText;
                    element.classList.remove('copy-success');
                }, 1500);
            }).catch(err => {
                console.error('无法复制文本: ', err);
            });
        }
    }

    function exportContent(content, filename) {
        const baseName = currentLoraFile?.name.replace('.safetensors', '') || `civitai_${document.getElementById('civitai-model-name').textContent.replace(/\s/g, '_')}`;
        const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${baseName}${filename}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    function exportDescription() {
        const modelDesc = document.getElementById('civitai-description').innerText;
        const versionDesc = document.getElementById('civitai-version-info').innerText;
        const content = `--- 模型介绍 ---\n\n${modelDesc}\n\n--- 版本信息 ---\n\n${versionDesc}`;
        exportContent(content, `.log`);
    }

    function exportTriggerWords() {
        const wordsContainer = document.getElementById('civitai-trained-words');
        const tags = Array.from(wordsContainer.querySelectorAll('.tag')).map(t => t.textContent);
        if(tags.length > 0) {
            exportContent(tags.join(', '), `.txt`);
        }
    }
    
    async function exportCurrentImage() {
        if (imageUrls.length === 0) return;
        const url = imageUrls[currentImageIndex];
        
        showLoading(`正在下载图片...`);
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`无法获取图片: ${response.statusText}`);
            const blob = await response.blob();
            
            let extension = '.jpg';
            try {
                const urlPath = new URL(url).pathname;
                const urlParts = urlPath.split('.');
                if (urlParts.length > 1) {
                    const ext = urlParts.pop().toLowerCase();
                    if (['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(ext)) {
                        extension = `.${ext}`;
                    }
                }
            } catch(e) { console.error("无法从URL解析图片格式, 默认使用.jpg"); }
            
            const baseName = currentLoraFile?.name.replace('.safetensors', '') || `civitai_${document.getElementById('civitai-model-name').textContent.replace(/\s/g, '_')}`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${baseName}_image_${currentImageIndex}${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (error) {
            console.error('图片下载失败:', error);
            alert(`图片下载失败: ${error.message}. 您可以尝试右键点击图片手动保存。`);
        } finally {
            hideLoading();
        }
    }
    
    async function updateAndDownloadLora() {
        if (!currentLoraFile) {
            alert("请先加载一个LoRA文件。");
            return;
        }
        let newMetadata;
        try {
            newMetadata = JSON.parse(metadataEditorTextarea.value);
        } catch(e) {
            alert("元数据格式错误！请确保内容是有效的JSON。");
            return;
        }
        showLoading('正在重新构建文件...');
        try {
            const fileBuffer = await currentLoraFile.arrayBuffer();
            const view = new DataView(fileBuffer);
            const metadataLength = Number(view.getBigUint64(0, true));
            const newHeader = { "__metadata__": newMetadata };
            const newHeaderBytes = new TextEncoder().encode(JSON.stringify(newHeader));
            const newFileBuffer = new ArrayBuffer(8 + newHeaderBytes.length + (fileBuffer.byteLength - 8 - metadataLength));
            const newView = new DataView(newFileBuffer);
            newView.setBigUint64(0, BigInt(newHeaderBytes.length), true);
            const newUint8Array = new Uint8Array(newFileBuffer);
            newUint8Array.set(newHeaderBytes, 8);
            const tensorData = new Uint8Array(fileBuffer, 8 + metadataLength);
            newUint8Array.set(tensorData, 8 + newHeaderBytes.length);
            const blob = new Blob([newFileBuffer], { type: "application/octet-stream" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${currentLoraFile.name.replace('.safetensors', '')}_edited.safetensors`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch(error) {
            alert(`更新文件失败: ${error.message}`);
            console.error(error);
        } finally {
            hideLoading();
        }
    }

    async function downloadLoraFromLink() {
        if (!currentCivitaiData || !currentCivitaiData.downloadUrl) {
            alert('没有可用的下载链接。');
            return;
        }
        showLoading('正在准备下载 LoRA...');
        try {
            const filename = currentCivitaiData.files[0]?.name || 'lora.safetensors';
            const a = document.createElement('a');
            a.href = currentCivitaiData.downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch(error) {
            console.error('LoRA 下载失败:', error);
            alert(`LoRA 下载失败: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    // --- Image Viewer Logic ---
    function updateImageViewer() {
        if (imageUrls.length === 0) return;
        previewImage.src = imageUrls[currentImageIndex];
        imageCounter.textContent = `${currentImageIndex + 1} / ${imageUrls.length}`;
        prevBtn.disabled = currentImageIndex === 0;
        nextBtn.disabled = currentImageIndex === imageUrls.length - 1;
        imageNav.classList.toggle('hidden', imageUrls.length < 1);
    }
    function showNextImage() {
        if (currentImageIndex < imageUrls.length - 1) {
            currentImageIndex++;
            updateImageViewer();
        }
    }
    function showPreviousImage() {
        if (currentImageIndex > 0) {
            currentImageIndex--;
            updateImageViewer();
        }
    }

    // --- Core File & API Functions ---
    async function parseSafetensorsMetadata(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const buffer = e.target.result;
            const view = new DataView(buffer);
            const metadataLength = Number(view.getBigUint64(0, true));
            if (metadataLength === 0) { resolve(null); return; }
            const metadataJson = new TextDecoder().decode(new Uint8Array(buffer, 8, metadataLength));
            const header = JSON.parse(metadataJson);
            resolve(header['__metadata__'] || null);
          } catch (err) { reject(new Error("解析元数据失败。")); }
        };
        reader.onerror = () => reject(new Error('无法读取文件。'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function calculateFileHash(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const buffer = e.target.result;
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    resolve(hashArray.map(b => b.toString(16).padStart(2, '0')).join(''));
                } catch (err) { reject(err); }
            };
            reader.onerror = () => reject(new Error('无法读取文件以计算哈希。'));
            reader.readAsArrayBuffer(file);
        });
    }

    async function fetchCivitaiDataByHash(hash) {
      try {
        const response = await fetch(`https://civitai.com/api/v1/model-versions/by-hash/${hash}`);
        if (!response.ok) return null;
        let data = await response.json();
        const modelResponse = await fetch(`https://civitai.com/api/v1/models/${data.modelId}`);
        data.model = await modelResponse.json();
        return data;
      } catch (error) {
        console.error("Civitai API 请求失败 (by hash):", error);
        return null;
      }
    }
    
    async function fetchCivitaiDataById(id, type = 'version') {
        let url;
        if (type === 'version') {
            url = `https://civitai.com/api/v1/model-versions/${id}`;
        } else {
            url = `https://civitai.com/api/v1/models/${id}`;
        }
        try {
            const response = await fetch(url);
            if (!response.ok) return null;
            let data = await response.json();
            if (type === 'version' && data.modelId) {
                const modelResponse = await fetch(`https://civitai.com/api/v1/models/${data.modelId}`);
                data.model = await modelResponse.json();
            }
            return data;
        } catch (error) {
            console.error(`Civitai API 请求失败 (by ${type} id):`, error);
            return null;
        }
    }
  </script>
</body>
</html>
