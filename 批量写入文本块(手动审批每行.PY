import sys
import os
from PIL import Image, PngImagePlugin # å¯¼å…¥ PngImagePlugin ç”¨äºå­˜å‚¨PNGå…ƒæ•°æ®
import tkinter as tk
from tkinter import filedialog, messagebox
import re # å¯¼å…¥ re æ¨¡å—ç”¨äºè‡ªç„¶æ’åº

# -------------------- é…ç½® --------------------
# ZMLèŠ‚ç‚¹ç”¨äºå­˜å‚¨æ–‡æœ¬å—çš„ç‰¹å®šé”®å
TEXT_BLOCK_KEY = "comfy_text_block"

# ç›®æ ‡å›¾ç‰‡æ–‡ä»¶æ‰©å±•åï¼ˆæ‰€æœ‰å›¾ç‰‡æœ€ç»ˆéƒ½åº”è¯¥æˆä¸ºPNGï¼‰
TARGET_EXTENSION = '.png' 

# æ‰€æœ‰æ”¯æŒè¯»å–å¹¶å¯èƒ½è½¬æ¢çš„å›¾ç‰‡æ–‡ä»¶æ‰©å±•å
READABLE_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.tiff', '.webp']
# ----------------------------------------------


def select_folder(title="è¯·é€‰æ‹©ä¸€ä¸ªå›¾åƒæ–‡ä»¶å¤¹"):
    """
    å¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†è®©ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚
    """
    root = tk.Tk()
    root.withdraw()
    folder_path = filedialog.askdirectory(title=title)
    root.destroy()
    return folder_path

def select_file(title="è¯·é€‰æ‹©ä¸€ä¸ªTXTæ–‡æœ¬æ–‡ä»¶", filetypes=[("Text files", "*.txt")]):
    """
    å¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†è®©ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ã€‚
    """
    root = tk.Tk()
    root.withdraw()
    file_path = filedialog.askopenfilename(title=title, filetypes=filetypes)
    root.destroy()
    return file_path

def write_text_to_image_metadata(image_filepath, text_content):
    """
    å°†æ–‡æœ¬å†…å®¹å†™å…¥åˆ°PNGå›¾åƒçš„comfy_text_blockå…ƒæ•°æ®ä¸­ã€‚
    """
    base_name = os.path.basename(image_filepath)
    try:
        with Image.open(image_filepath) as img:
            if img.format != "PNG":
                print(f"âŒ å†…éƒ¨é”™è¯¯: å›¾ç‰‡ '{base_name}' æ ¼å¼ä¸æ˜¯PNGï¼Œæ— æ³•å†™å…¥æ–‡æœ¬å—ã€‚")
                return False

            pnginfo = PngImagePlugin.PngInfo()
            for k, v in img.info.items():
                if k != TEXT_BLOCK_KEY and isinstance(k, str) and isinstance(v, str): 
                    pnginfo.add_text(k, v)
            
            pnginfo.add_text(TEXT_BLOCK_KEY, text_content)
            
            img.save(image_filepath, pnginfo=pnginfo)
            # print(f"âœ… æˆåŠŸå†™å…¥: '{base_name}' çš„æ–‡æœ¬å—ã€‚") # è¿™ä¸€æ­¥åœ¨ä¸»è¦å¾ªç¯ä¸­ç»Ÿä¸€æ˜¾ç¤º
            return True

    except FileNotFoundError:
        print(f"âŒ é”™è¯¯: æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶ '{base_name}'ã€‚")
        return False
    except Exception as e:
        print(f"âŒ é”™è¯¯: å†™å…¥å›¾ç‰‡ '{base_name}' çš„æ–‡æœ¬å—æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        return False

def convert_to_png_and_delete_original(file_path):
    """
    å°†æŒ‡å®šæ–‡ä»¶è½¬æ¢ä¸ºPNGæ ¼å¼ï¼Œç„¶ååˆ é™¤åŸå§‹æ–‡ä»¶ã€‚
    """
    base_name = os.path.basename(file_path)
    folder_path = os.path.dirname(file_path)
    name_without_ext = os.path.splitext(base_name)[0]
    new_filepath_base = os.path.join(folder_path, name_without_ext) # å…ˆä¸åŠ æ‰©å±•å
    
    # é˜²æ­¢æ–‡ä»¶é‡åå†²çªï¼šå¦‚æœè½¬æ¢åçš„æ–‡ä»¶åå·²ç»å­˜åœ¨ï¼Œå°è¯•æ·»åŠ åç¼€
    counter = 0
    final_new_filepath = new_filepath_base + TARGET_EXTENSION
    while os.path.exists(final_new_filepath) and final_new_filepath != file_path:
        counter += 1
        final_new_filepath = name_without_ext + f"_{counter}" + TARGET_EXTENSION
        final_new_filepath = os.path.join(folder_path, final_new_filepath)

    if counter > 0:
        print(f"â— è­¦å‘Š: è½¬æ¢åæ–‡ä»¶å '{name_without_ext}{TARGET_EXTENSION}' å·²å­˜åœ¨ï¼Œå°†ä¿å­˜ä¸º '{os.path.basename(final_new_filepath)}'ã€‚")

    try:
        with Image.open(file_path) as img:
            if img.mode not in ("RGB", "RGBA"):
                img = img.convert("RGBA")

            pnginfo_to_transfer = PngImagePlugin.PngInfo()
            if img.format == "PNG" and img.info:
                 for k, v in img.info.items():
                     if isinstance(k, str) and isinstance(v, str):
                         pnginfo_to_transfer.add_text(k, v)

            if pnginfo_to_transfer.text:
                img.save(final_new_filepath, pnginfo=pnginfo_to_transfer)
            else:
                img.save(final_new_filepath)
            
            print(f"â¡ï¸ æˆåŠŸè½¬æ¢: '{base_name}' -> '{os.path.basename(final_new_filepath)}'")
        
        # åªæœ‰å½“åŸå§‹æ–‡ä»¶ä¸æ˜¯åŒåPNGæ—¶æ‰åˆ é™¤ã€‚å¦‚æœæ˜¯åŒåPNGï¼Œå…¶å®å°±æ˜¯å†™å…¥è¦†ç›–ï¼Œä¸éœ€åˆ é™¤ã€‚
        if file_path != final_new_filepath:
            os.remove(file_path)
            print(f"ğŸ—‘ï¸ æˆåŠŸåˆ é™¤åŸå§‹æ–‡ä»¶: '{base_name}'")
        return True, final_new_filepath

    except Exception as e:
        print(f"âŒ é”™è¯¯: è½¬æ¢æˆ–åˆ é™¤æ–‡ä»¶ '{base_name}' æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        return False, None

def process_current_image(
    image_folder_path, 
    original_filename, 
    image_temp_filepath, 
    new_image_name, 
    text_blocks
):
    """
    å¤„ç†å½“å‰å›¾ç‰‡çš„é‡å‘½åå’Œæ–‡æœ¬å—å†™å…¥ã€‚
    è¿”å›Trueè¡¨ç¤ºæˆåŠŸå¤„ç†ï¼ŒFalseè¡¨ç¤ºå¤±è´¥ã€‚
    """
    processed_successfully = True

    # 1. ç¡®ä¿å›¾ç‰‡æ˜¯PNGæ ¼å¼ (å¦‚æœä¸æ˜¯ï¼Œè¿›è¡Œè½¬æ¢)
    # image_temp_filepath å·²ç»æ˜¯ä»è¿™é‡Œå‡ºå»çš„å”¯ä¸€PNGè·¯å¾„ï¼Œæˆ–è€…åŸå§‹è·¯å¾„å°±æ˜¯PNG
    
    # 2. å¦‚æœæ–°åç§°å·²è®¾å®šï¼Œè¿›è¡Œé‡å‘½å
    final_image_filepath = image_temp_filepath
    if new_image_name:
        final_new_name_with_ext = new_image_name + TARGET_EXTENSION
        desired_final_filepath = os.path.join(image_folder_path, final_new_name_with_ext)

        if final_image_filepath != desired_final_filepath: # é¿å…è‡ªå·±é‡å‘½åè‡ªå·±
            if os.path.exists(desired_final_filepath):
                print(f"âŒ é‡å‘½åå¤±è´¥ï¼šç›®æ ‡æ–‡ä»¶å '{final_new_name_with_ext}' å·²å­˜åœ¨ã€‚å°†ä¸å¯¹è¯¥å›¾ç‰‡é‡å‘½åï¼Œå¹¶å°è¯•å†™å…¥å…ƒæ•°æ®åˆ°å…¶å½“å‰è·¯å¾„ã€‚")
                # ä¸æ›´æ–° final_image_filepathï¼Œä¿æŒåœ¨å½“å‰è·¯å¾„è¿›è¡Œå…ƒæ•°æ®å†™å…¥
                # å¹¶æ ‡è®°ä¸ºéƒ¨åˆ†å¤±è´¥
                processed_successfully = False 
            else:
                try:
                    os.rename(final_image_filepath, desired_final_filepath)
                    print(f"âœ… æˆåŠŸé‡å‘½å: '{os.path.basename(final_image_filepath)}' -> '{final_new_name_with_ext}'")
                    final_image_filepath = desired_final_filepath # æ›´æ–°è·¯å¾„ä¸ºé‡å‘½ååçš„è·¯å¾„
                except Exception as e:
                    print(f"âŒ é‡å‘½åæ–‡ä»¶ '{os.path.basename(final_image_filepath)}' ä¸º '{final_new_name_with_ext}' å¤±è´¥: {e}ã€‚")
                    processed_successfully = False # æ ‡è®°å¤±è´¥

    # 3. å†™å…¥æ–‡æœ¬å—åˆ°æœ€ç»ˆè·¯å¾„çš„å›¾ç‰‡
    if text_blocks:
        # åˆå¹¶æ‰€æœ‰æ–‡æœ¬å—ï¼Œç”¨åŒæ¢è¡Œç¬¦åˆ†éš”
        combined_text_content = "\n\n".join(text_blocks)
        if write_text_to_image_metadata(final_image_filepath, combined_text_content):
            print(f"âœ… æˆåŠŸå†™å…¥æ–‡æœ¬å—åˆ°: '{os.path.basename(final_image_filepath)}'ã€‚")
        else:
            print(f"âŒ å†™å…¥æ–‡æœ¬å—åˆ° '{os.path.basename(final_image_filepath)}' å¤±è´¥ã€‚")
            processed_successfully = False # æ ‡è®°å¤±è´¥
    else:
        print(f"â— æœªä¸ºå›¾ç‰‡ '{os.path.basename(final_image_filepath)}' æŒ‡å®šæ–‡æœ¬å—ï¼Œè·³è¿‡å†™å…¥ã€‚")

    return processed_successfully


def main():
    """
    è„šæœ¬ä¸»å…¥å£ã€‚
    """
    root = tk.Tk()
    root.withdraw() # éšè—Tkinterä¸»çª—å£ï¼Œåªæ˜¾ç¤ºå¯¹è¯æ¡†

    messagebox.showinfo(
        "æç¤º", 
        "è¿™æ˜¯ä¸€ä¸ªäº¤äº’å¼è„šæœ¬ã€‚è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾åƒæ–‡ä»¶å¤¹ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªTXTæ–‡ä»¶ã€‚\n"
        "è„šæœ¬å°†æŒ‡å¯¼æ‚¨é€è¡Œå¤„ç†TXTå†…å®¹ã€‚\n"
        "å¯¹äºTXTçš„æ¯ä¸€è¡Œï¼Œæ‚¨å¯ä»¥é€‰æ‹©å°†å…¶ä½œä¸ºå›¾ç‰‡çš„æ–°åç§°ï¼Œæˆ–ä½œä¸ºæ–‡æœ¬å—å†™å…¥ã€‚\n"
        "å¤šä¸ªæ–‡æœ¬å—ä¼šè‡ªåŠ¨ç”¨åŒæ¢è¡Œç¬¦éš”å¼€ã€‚\n"
        "æ³¨æ„ï¼šè„šæœ¬å°†ç›´æ¥ä¿®æ”¹åŸå›¾çš„æ–‡ä»¶åå’Œå…ƒæ•°æ®ï¼Œ**ä¸åˆ›å»ºå¤‡ä»½ï¼**"
    )

    # 1. é€‰æ‹©å›¾åƒæ–‡ä»¶å¤¹
    image_folder_path = select_folder("è¯·é€‰æ‹©ä¸€ä¸ªå›¾åƒæ–‡ä»¶å¤¹ (é‡Œé¢çš„å›¾ç‰‡å°†è¢«é‡å‘½åå’Œå†™å…¥æ–‡æœ¬å—)")
    if not image_folder_path:
        messagebox.showinfo("å–æ¶ˆ", "æœªé€‰æ‹©å›¾åƒæ–‡ä»¶å¤¹ï¼Œè„šæœ¬é€€å‡ºã€‚")
        sys.exit()

    # 2. é€‰æ‹©TXTæ–‡ä»¶
    txt_file_path = select_file("è¯·é€‰æ‹©ä¸€ä¸ªTXTæ–‡æœ¬æ–‡ä»¶ (æä¾›æ–°æ–‡ä»¶åå’Œæ–‡æœ¬å—å†…å®¹)", [("Text files", "*.txt")])
    if not txt_file_path:
        messagebox.showinfo("å–æ¶ˆ", "æœªé€‰æ‹©TXTæ–‡ä»¶ï¼Œè„šæœ¬é€€å‡ºã€‚")
        sys.exit()

    print("\n" + "="*80)
    print(f"å¾…å¤„ç†å›¾åƒæ–‡ä»¶å¤¹: {image_folder_path}")
    print(f"æ–‡æœ¬æºæ–‡ä»¶ (TXT): {txt_file_path}")
    print("æ³¨æ„: è„šæœ¬å°†ç›´æ¥ä¿®æ”¹åŸå›¾ï¼Œä¸åˆ›å»ºå¤‡ä»½ã€‚è¯·ç¡®ä¿æ‚¨å·²å¤‡ä»½é‡è¦æ–‡ä»¶ï¼")
    print("æ“ä½œæ¨¡å¼: é€è¡Œäº¤äº’å¼å¤„ç†ï¼Œæ¯æ¬¡å¤„ç†ä¸€å¼ å›¾ç‰‡ã€‚")
    print("="*80 + "\n")

    # 3. è·å–å¹¶æ’åºæ‰€æœ‰å¾…å¤„ç†çš„å›¾ç‰‡æ–‡ä»¶
    all_raw_image_files_sorted = sorted([f for f in os.listdir(image_folder_path) 
                                         if os.path.splitext(f)[1].lower() in READABLE_EXTENSIONS],
                                        key=lambda x: [int(s) if s.isdigit() else s.lower() for s in re.split('([0-9]+)', os.path.splitext(x)[0])])
    
    if not all_raw_image_files_sorted:
        messagebox.showerror("é”™è¯¯", f"æ‰€é€‰å›¾åƒæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°ä»»ä½•æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆ{', '.join(READABLE_EXTENSIONS)}ï¼‰ã€‚")
        sys.exit()

    num_images_to_process = len(all_raw_image_files_sorted)
    print(f"å¾…å¤„ç†æ–‡ä»¶ (æŒ‰è‡ªç„¶é¡ºåºæ’åˆ—): {num_images_to_process} å¼ ã€‚\n")


    # 4. åˆå§‹åŒ–å¤„ç†çŠ¶æ€å’Œç»Ÿè®¡
    image_processed_count = 0
    text_processed_count = 0
    total_renamed_count = 0
    total_write_success_count = 0
    total_fail_count = 0

    # 5. æ‰“å¼€TXTæ–‡ä»¶å‡†å¤‡é€è¡Œè¯»å–
    try:
        txt_file = open(txt_file_path, 'r', encoding='utf-8-sig')
    except Exception as e:
        messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€TXTæ–‡ä»¶è¿›è¡Œè¯»å–: {e}")
        sys.exit()

    # 6. ä¸»å¾ªç¯ï¼šé€ä¸ªå¤„ç†å›¾ç‰‡
    current_txt_line = "" # å½“å‰ä»TXTè¯»å–åˆ°çš„è¡Œ
    txt_line_num = 0      # å½“å‰TXTè¡Œå·

    while image_processed_count < num_images_to_process:
        original_filename = all_raw_image_files_sorted[image_processed_count]
        original_filepath = os.path.join(image_folder_path, original_filename)
        
        print("\n" + "*"*80)
        print(f"----- å¼€å§‹å¤„ç†ç¬¬ {image_processed_count + 1} å¼ å›¾ç‰‡: '{original_filename}' -----")
        print("*"*80)

        # å‡†å¤‡å½“å‰å›¾ç‰‡çš„çŠ¶æ€å˜é‡
        # current_image_temp_filepath è½¬æ¢åçš„PNGæ–‡ä»¶è·¯å¾„ï¼Œæˆ–åŸå§‹PNGæ–‡ä»¶è·¯å¾„
        current_image_temp_filepath = original_filepath 
        new_image_name_for_current_image = None
        text_blocks_for_current_image = []

        # A. ç¡®ä¿å›¾ç‰‡æ˜¯PNGæ ¼å¼ (å¦‚æœä¸æ˜¯ï¼Œè¿›è¡Œè½¬æ¢)
        if os.path.splitext(original_filename)[1].lower() != TARGET_EXTENSION:
            print(f"  å›¾ç‰‡ '{original_filename}' æ£€æµ‹åˆ°éPNGæ ¼å¼ï¼Œå°è¯•è½¬æ¢ä¸ºPNG...")
            success_convert, converted_filepath = convert_to_png_and_delete_original(original_filepath)
            if not success_convert:
                print(f"âŒ è½¬æ¢ '{original_filename}' å¤±è´¥ï¼Œè·³è¿‡æ­¤å›¾ç‰‡ã€‚")
                total_fail_count += 1
                image_processed_count += 1 # ç§»åŠ¨åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡
                continue # ç»§ç»­å¤–å±‚å¾ªç¯ï¼Œå¤„ç†ä¸‹ä¸€å¼ å›¾ç‰‡
            current_image_temp_filepath = converted_filepath # æ›´æ–°ä¸ºè½¬æ¢åçš„PNGæ–‡ä»¶è·¯å¾„
            print(f"  è½¬æ¢æˆåŠŸï¼Œå½“å‰å›¾ç‰‡å¤„ç†è·¯å¾„ä¸º: '{os.path.basename(current_image_temp_filepath)}'")
        else:
            print("  å›¾ç‰‡å·²ç»æ˜¯PNGæ ¼å¼ï¼Œæ— éœ€è½¬æ¢ã€‚")
            current_image_temp_filepath = original_filepath # ç¡®ä¿è·¯å¾„æ­£ç¡®

        # B. äº¤äº’å¼å¤„ç†TXTè¡Œï¼Œç›´åˆ°ç”¨æˆ·åˆ‡æ¢å›¾ç‰‡æˆ–TXTè¯»å®Œ
        while True:
            # å°è¯•ä»TXTæ–‡ä»¶è¯»å–ä¸‹ä¸€è¡Œï¼Œå¦‚æœä¹‹å‰å·²ç»è¯»è¿‡ä½†æœªå¤„ç†ï¼Œåˆ™ä½¿ç”¨å·²æœ‰çš„è¡Œ
            current_txt_line = current_txt_line if current_txt_line else txt_file.readline()
            
            if not current_txt_line: # TXTæ–‡ä»¶å·²è¯»å®Œ
                print("\nâ— TXTæ–‡ä»¶å·²å…¨éƒ¨è¯»å–å®Œæ¯•ã€‚")
                break # é€€å‡ºå†…éƒ¨å¾ªç¯ï¼Œå‡†å¤‡å¤„ç†å½“å‰å›¾ç‰‡å¹¶ç»“æŸä»»åŠ¡

            txt_line = current_txt_line.strip()
            txt_line_num += 1 # TXTè¡Œå·é€’å¢

            if not txt_line: # è·³è¿‡ç©ºè¡Œ
                current_txt_line = "" # æ¸…ç©ºï¼Œä»¥ä¾¿è¯»å–ä¸‹ä¸€è¡Œ
                continue

            print("\n" + "-"*50)
            print(f"å½“å‰å›¾ç‰‡: '{os.path.basename(current_image_temp_filepath)}'")
            print(f"å·²æŒ‡å®šæ–°åç§°: '{new_image_name_for_current_image}'" if new_image_name_for_current_image else "æœªæŒ‡å®šæ–°åç§°")
            print(f"å·²æ”¶é›†æ–‡æœ¬å—: {len(text_blocks_for_current_image)} ä¸ª")
            print("-" * 50)
            print(f"  æ­£åœ¨å®¡é˜…TXTç¬¬ {txt_line_num} è¡Œå†…å®¹: '{txt_line}'")
            print("  è¯·é€‰æ‹©æ“ä½œï¼š")
            print("    1 - å°†æ­¤è¡Œä½œä¸ºå›¾ç‰‡æ–°åç§° (è¦†ç›–æ—§åç§°)")
            print("    2 - å°†æ­¤è¡Œä½œä¸ºæ–‡æœ¬å— (æ·»åŠ åˆ°ç°æœ‰æ–‡æœ¬å—åé¢)")
            print("    0 - ç»“æŸå½“å‰å›¾ç‰‡å¤„ç†ï¼Œå¼€å§‹å¤„ç†ä¸‹ä¸€å¼ å›¾ç‰‡")
            print("    Q - é€€å‡ºæ•´ä¸ªè„šæœ¬")
            
            user_choice = input("  æ‚¨çš„é€‰æ‹© (1/2/0/Q): ").strip().upper()
            
            if user_choice == '1':
                if new_image_name_for_current_image:
                    print(f"â— è­¦å‘Š: æ–°å›¾ç‰‡åç§°å°†ä» '{new_image_name_for_current_image}' å˜æ›´ä¸º '{txt_line}'ã€‚")
                new_image_name_for_current_image = txt_line
                print(f"  âœ”ï¸ å·²æŒ‡å®šæ–°å›¾ç‰‡åç§°: '{new_image_name_for_current_image}'")
                text_processed_count += 1
            elif user_choice == '2':
                text_blocks_for_current_image.append(txt_line)
                print(f"  âœ”ï¸ å·²å°†æ­¤è¡Œä½œä¸ºæ–‡æœ¬å—æ·»åŠ åˆ°åˆ—è¡¨ã€‚å½“å‰å…± '{len(text_blocks_for_current_image)}' ä¸ªæ–‡æœ¬å—ã€‚")
                text_processed_count += 1
            elif user_choice == '0':
                print("  å³å°†ç»“æŸå½“å‰å›¾ç‰‡å¤„ç†ï¼Œå‡†å¤‡å¤„ç†ä¸‹ä¸€å¼ å›¾ç‰‡ã€‚")
                break # é€€å‡ºå†…éƒ¨å¾ªç¯ï¼Œæ‰§è¡Œå½“å‰å›¾ç‰‡çš„ä¿å­˜æ“ä½œ
            elif user_choice == 'Q':
                if messagebox.askyesno("ç¡®è®¤é€€å‡º", "æ‚¨ç¡®å®šè¦é€€å‡ºæ•´ä¸ªè„šæœ¬å—ï¼Ÿæœªä¿å­˜çš„å½“å‰å›¾ç‰‡æ›´æ”¹å°†ä¸¢å¤±ã€‚"):
                    txt_file.close()
                    sys.exit("ç”¨æˆ·é€‰æ‹©é€€å‡ºã€‚")
                else:
                    print("ç”¨æˆ·å–æ¶ˆé€€å‡ºï¼Œç»§ç»­å¤„ç†å½“å‰å›¾ç‰‡ã€‚")
                    current_txt_line = txt_line # æ¢å¤å½“å‰è¡Œï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
                    txt_line_num -= 1 # è¡Œå·å›é€€
                    continue
            else:
                print("æ— æ•ˆè¾“å…¥ï¼Œè¯·é‡æ–°è¾“å…¥ (1, 2, 0 æˆ– Q)ã€‚")
                current_txt_line = txt_line # ä¿æŒå½“å‰è¡Œï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
                txt_line_num -= 1 # è¡Œå·å›é€€
                continue
            
            current_txt_line = "" # å½“å‰è¡Œå·²å¤„ç†ï¼Œæ¸…ç©ºä»¥ä¾¿è¯»å–ä¸‹ä¸€è¡Œ

        # C. å¤„ç†å½“å‰å›¾ç‰‡ï¼ˆé‡å‘½åå’Œå†™å…¥æ–‡æœ¬å—ï¼‰
        print("\n" + "="*50)
        print(f"æ­£åœ¨ä¿å­˜å›¾ç‰‡ '{os.path.basename(current_image_temp_filepath)}' çš„æ›´æ”¹...")
        processed_ok = process_current_image(
            image_folder_path, 
            original_filename, # åŸå§‹æ–‡ä»¶åä»…ç”¨äºæ—¥å¿—ï¼Œä¸ç”¨äºåç»­å¤„ç†
            current_image_temp_filepath, 
            new_image_name_for_current_image, 
            text_blocks_for_current_image
        )

        if processed_ok:
            print(f"æˆåŠŸå¤„ç†äº†å›¾ç‰‡ '{os.path.basename(new_image_name_for_current_image + TARGET_EXTENSION if new_image_name_for_current_image else os.path.basename(current_image_temp_filepath))}'ã€‚")
            image_processed_count += 1
            total_renamed_count += (1 if new_image_name_for_current_image else 0)
            total_write_success_count += (1 if text_blocks_for_current_image else 0)
        else:
            print(f"å¤„ç†å›¾ç‰‡ '{os.path.basename(current_image_temp_filepath)}' å¤±è´¥æˆ–éƒ¨åˆ†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—ã€‚")
            total_fail_count += 1
            image_processed_count += 1 # å³ä½¿å¤±è´¥ä¹Ÿç§»åŠ¨åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡ï¼Œé™¤éç”¨æˆ·æ˜ç¡®æƒ³é‡è¯•

        # å¦‚æœTXTæ–‡ä»¶å·²è¯»å®Œï¼Œä¸”æ‰€æœ‰å›¾ç‰‡ä¹Ÿå¤„ç†å®Œæ¯•ï¼Œåˆ™é€€å‡º
        if not current_txt_line and image_processed_count >= num_images_to_process:
            break

    # 7. ç»“æŸç»Ÿè®¡å’Œæ¸…ç†
    txt_file.close() # å…³é—­TXTæ–‡ä»¶

    print("\n" + "="*80)
    print("æ‰€æœ‰å›¾ç‰‡å¤„ç†å®Œæ¯•æˆ–TXTæ–‡ä»¶å·²è¯»å®Œï¼")
    print(f"æ€»å…±ä¿®æ”¹äº†: {image_processed_count} å¼ å›¾ç‰‡")
    print(f"å…¶ä¸­ï¼ŒæˆåŠŸé‡å‘½åäº†: {total_renamed_count} å¼ å›¾ç‰‡")
    print(f"æˆåŠŸå†™å…¥æ–‡æœ¬å—åˆ°: {total_write_success_count} å¼ å›¾ç‰‡")
    print(f"å¤„ç†å¤±è´¥ (è½¬æ¢/é‡å‘½å/å†™å…¥): {total_fail_count} å¼ å›¾ç‰‡")
    print("="*80)
    
    # æœ€ç»ˆç»“æœå¼¹çª—
    messagebox.showinfo(
        "å®Œæˆ", 
        f"æ‰¹é‡å¤„ç†ä»»åŠ¡å·²å®Œæˆï¼\n"
        f"å¤„ç†å›¾ç‰‡æ€»æ•°: {image_processed_count} å¼ \n"
        f"æˆåŠŸé‡å‘½å: {total_renamed_count} å¼ å›¾ç‰‡\n"
        f"æˆåŠŸå†™å…¥æ–‡æœ¬å—: {total_write_success_count} å¼ å›¾ç‰‡\n"
        f"å¤„ç†å¤±è´¥: {total_fail_count} å¼ å›¾ç‰‡"
    )
    
    root.destroy() 


if __name__ == "__main__":
    try:
        main()
    except SystemExit as e:
        print(e)
    except Exception as e:
        messagebox.showerror("ç¨‹åºé”™è¯¯", f"å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯: {e}")
        print(f"å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯: {e}")
    finally:
        input("\næ‰€æœ‰æ“ä½œå·²å®Œæˆï¼ŒæŒ‰ Enter é”®é€€å‡º...")

