<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>解析lora元数据</title>
    <meta charset="UTF-8">
    <style>
        /* Theme Variables */
        :root[data-theme="dark"] { 
            --bg: #1e1e1e; 
            --bg-panel: #252525;
            --bg-panel-hover: #2d2d2d;
            --text-color: #e0e0e0; 
            --text-muted: #aaa;
            --border-color: #3a3a3a;
            --accent-color: #4dabf7;
            --btn-bg: #4a4a4a;
            --btn-hover-bg: #5a5a5a;
            --btn-action-bg: #4CAF50;
            --btn-action-hover-bg: #5cb85c;
            --drop-area-bg: #2d2d2d;
            --drop-area-hover: #3e3a3e;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glow-color: rgba(74, 171, 247, 0.3);
        }

        :root[data-theme="light"] {
            --bg: #f8f9fa;
            --bg-panel: #ffffff;
            --bg-panel-hover: #f1f3f4;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --btn-bg: #e9ecef;
            --btn-hover-bg: #dee2e6;
            --btn-action-bg: #198754;
            --btn-action-hover-bg: #157347;
            --drop-area-bg: #f8f9fa;
            --drop-area-hover: #e9ecef;
            --gradient-primary: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            --gradient-secondary: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            --glow-color: rgba(13, 110, 253, 0.3);
        }

        :root[data-theme="blue"] {
            --bg: #0f1419;
            --bg-panel: #1a2332;
            --bg-panel-hover: #243447;
            --text-color: #e6f1ff;
            --text-muted: #8bb9fe;
            --border-color: #2d4663;
            --accent-color: #00d4ff;
            --btn-bg: #2d4663;
            --btn-hover-bg: #3a5a7a;
            --btn-action-bg: #0066cc;
            --btn-action-hover-bg: #0052a3;
            --drop-area-bg: #243447;
            --drop-area-hover: #2d4663;
            --gradient-primary: linear-gradient(135deg, #00d4ff 0%, #0066cc 100%);
            --gradient-secondary: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            --glow-color: rgba(0, 212, 255, 0.3);
        }

        :root[data-theme="purple"] {
            --bg: #1a0d26;
            --bg-panel: #2d1b3d;
            --bg-panel-hover: #3d2952;
            --text-color: #f0e6ff;
            --text-muted: #c299ff;
            --border-color: #4d3366;
            --accent-color: #a855f7;
            --btn-bg: #4d3366;
            --btn-hover-bg: #5c3d7a;
            --btn-action-bg: #7c3aed;
            --btn-action-hover-bg: #6d28d9;
            --drop-area-bg: #3d2952;
            --drop-area-hover: #4d3366;
            --gradient-primary: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            --gradient-secondary: linear-gradient(135deg, #e17cff 0%, #c084fc 100%);
            --glow-color: rgba(168, 85, 247, 0.3);
        }

        :root[data-theme="green"] {
            --bg: #0d1f0d;
            --bg-panel: #1a331a;
            --bg-panel-hover: #264d26;
            --text-color: #e6ffe6;
            --text-muted: #99cc99;
            --border-color: #336633;
            --accent-color: #22c55e;
            --btn-bg: #336633;
            --btn-hover-bg: #4d7a4d;
            --btn-action-bg: #16a34a;
            --btn-action-hover-bg: #15803d;
            --drop-area-bg: #264d26;
            --drop-area-hover: #336633;
            --gradient-primary: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --gradient-secondary: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
            --glow-color: rgba(34, 197, 94, 0.3);
        }

        :root[data-theme="orange"] {
            --bg: #1f1408;
            --bg-panel: #332211;
            --bg-panel-hover: #4d3319;
            --text-color: #fff5e6;
            --text-muted: #ffcc99;
            --border-color: #664422;
            --accent-color: #f97316;
            --btn-bg: #664422;
            --btn-hover-bg: #7a5533;
            --btn-action-bg: #ea580c;
            --btn-action-hover-bg: #c2410c;
            --drop-area-bg: #4d3319;
            --drop-area-hover: #664422;
            --gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            --gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --glow-color: rgba(249, 115, 22, 0.3);
        }

        /* Background Decorations */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--custom-bg, var(--bg));
            z-index: -3;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, var(--glow-color) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--glow-color) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--glow-color) 0%, transparent 50%),
                radial-gradient(circle at 60% 70%, var(--glow-color) 0%, transparent 30%);
            z-index: -2;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
            25% { transform: translateY(-30px) rotate(2deg) scale(1.1); }
            50% { transform: translateY(20px) rotate(-1deg) scale(0.9); }
            75% { transform: translateY(-10px) rotate(1deg) scale(1.05); }
        }

        /* Geometric decorations */
        .geometric-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .geometric-shape {
            position: absolute;
            opacity: 0.1;
            animation: geometric-float 25s infinite linear;
        }

        .shape-triangle {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 25px solid var(--accent-color);
        }

        .shape-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
        }

        .shape-square {
            width: 18px;
            height: 18px;
            background: var(--accent-color);
            transform: rotate(45deg);
        }

        .shape-hexagon {
            width: 20px;
            height: 11px;
            background: var(--accent-color);
            position: relative;
        }

        .shape-hexagon:before,
        .shape-hexagon:after {
            content: "";
            position: absolute;
            width: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
        }

        .shape-hexagon:before {
            bottom: 100%;
            border-bottom: 6px solid var(--accent-color);
        }

        .shape-hexagon:after {
            top: 100%;
            border-top: 6px solid var(--accent-color);
        }

        @keyframes geometric-float {
            0% {
                transform: translateY(100vh) translateX(-50px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.1;
            }
            90% {
                opacity: 0.1;
            }
            100% {
                transform: translateY(-100px) translateX(50px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Enhanced particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            animation: particle-float 20s infinite linear;
        }

        .particle-small {
            width: 3px;
            height: 3px;
            background: var(--accent-color);
        }

        .particle-medium {
            width: 6px;
            height: 6px;
            background: var(--accent-color);
            box-shadow: 0 0 10px var(--glow-color);
        }

        .particle-large {
            width: 8px;
            height: 8px;
            background: var(--gradient-primary);
            box-shadow: 0 0 15px var(--glow-color);
        }

        .particle-glow {
            width: 4px;
            height: 4px;
            background: var(--accent-color);
            box-shadow: 0 0 20px var(--glow-color), 0 0 40px var(--glow-color);
            animation: particle-glow 20s infinite linear, pulse 3s infinite;
        }

        @keyframes particle-float {
            0% {
                transform: translateY(100vh) translateX(0px) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
                transform: scale(1);
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) translateX(200px) scale(0);
                opacity: 0;
            }
        }

        @keyframes particle-glow {
            0% {
                transform: translateY(100vh) translateX(0px) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
                transform: scale(1);
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) translateX(150px) scale(0);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        /* Mouse trail effect */
        .mouse-trail {
            position: fixed;
            width: 6px;
            height: 6px;
            background: var(--accent-color);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.7;
            animation: trail-fade 1s ease-out forwards;
            box-shadow: 0 0 10px var(--glow-color);
        }

        @keyframes trail-fade {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        /* Ripple effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: var(--glow-color);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Base Styles */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px;
            transition: color 0.3s ease;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            padding: 30px; 
            border-radius: 25px; 
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.05) inset,
                0 0 100px var(--glow-color);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0.8;
            animation: glow-pulse 3s ease-in-out infinite;
        }

        .container::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle, var(--glow-color) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.03;
            animation: pattern-drift 30s linear infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes pattern-drift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .header { 
            text-align: center; 
            font-size: 2em;
            font-weight: bold;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 2px;
            animation: header-glow 2s ease-in-out infinite;
        }

        @keyframes header-glow {
            0%, 100% { box-shadow: 0 0 10px var(--glow-color); }
            50% { box-shadow: 0 0 20px var(--glow-color), 0 0 30px var(--glow-color); }
        }

        .controls-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-selector, .bg-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 10px;
            background: var(--bg-panel-hover);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .theme-selector::before, .bg-selector::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--glow-color), transparent);
            animation: selector-shine 4s infinite;
        }

        @keyframes selector-shine {
            0% { left: -100%; }
            50% { left: -100%; }
            100% { left: 100%; }
        }

        .theme-btn, .bg-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .theme-btn:hover, .bg-btn:hover {
            transform: scale(1.3);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3), 0 0 30px var(--glow-color);
        }

        .theme-btn.active, .bg-btn.active {
            transform: scale(1.4);
            box-shadow: 0 0 0 3px var(--accent-color), 0 0 30px var(--glow-color);
            animation: active-pulse 2s infinite;
        }

        @keyframes active-pulse {
            0%, 100% { box-shadow: 0 0 0 3px var(--accent-color), 0 0 30px var(--glow-color); }
            50% { box-shadow: 0 0 0 5px var(--accent-color), 0 0 40px var(--glow-color); }
        }

        .theme-btn[data-theme="dark"] { background: linear-gradient(45deg, #1e1e1e, #4dabf7); }
        .theme-btn[data-theme="light"] { background: linear-gradient(45deg, #ffffff, #0d6efd); }
        .theme-btn[data-theme="blue"] { background: linear-gradient(45deg, #0f1419, #00d4ff); }
        .theme-btn[data-theme="purple"] { background: linear-gradient(45deg, #1a0d26, #a855f7); }
        .theme-btn[data-theme="green"] { background: linear-gradient(45deg, #0d1f0d, #22c55e); }
        .theme-btn[data-theme="orange"] { background: linear-gradient(45deg, #1f1408, #f97316); }

        .bg-btn[data-bg="default"] { background: var(--gradient-primary); }
        .bg-btn[data-bg="gradient1"] { background: linear-gradient(45deg, #667eea, #764ba2); }
        .bg-btn[data-bg="gradient2"] { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .bg-btn[data-bg="gradient3"] { background: linear-gradient(45deg, #4facfe, #00f2fe); }
        .bg-btn[data-bg="gradient4"] { background: linear-gradient(45deg, #43e97b, #38f9d7); }
        .bg-btn[data-bg="pattern"] { 
            background: 
                radial-gradient(circle at 25% 25%, var(--accent-color) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, var(--accent-color) 2px, transparent 2px);
            background-size: 20px 20px;
            background-color: var(--bg);
        }

        #link-input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        #link-input-section::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: var(--gradient-primary);
            border-radius: 15px;
            opacity: 0.1;
            z-index: -1;
            animation: section-glow 4s ease-in-out infinite;
        }

        @keyframes section-glow {
            0%, 100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(1.02); }
        }

        #civitai-url-input {
            flex-grow: 1;
            background: var(--bg);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #civitai-url-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--glow-color), 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        #parse-link-btn, #download-lora-btn {
            background: var(--gradient-primary);
            color: white; 
            border: none;
            padding: 15px 30px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: bold; 
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #parse-link-btn::before, #download-lora-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        #parse-link-btn:hover::before, #download-lora-btn:hover::before {
            left: 100%;
        }

        #parse-link-btn:hover, #download-lora-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3), 0 0 30px var(--glow-color);
        }

        #dropArea { 
            width: 100%; 
            border: 3px dashed var(--border-color); 
            text-align: center; 
            padding: 80px 20px; 
            margin-bottom: 20px; 
            background: var(--drop-area-bg);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #dropArea::before {
            content: '📁';
            font-size: 4em;
            display: block;
            margin-bottom: 15px;
            animation: bounce 2s infinite, rotate-slight 4s ease-in-out infinite;
            filter: drop-shadow(0 0 10px var(--glow-color));
        }

        #dropArea::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, var(--glow-color) 2px, transparent 2px),
                radial-gradient(circle at 70% 70%, var(--glow-color) 1px, transparent 1px);
            background-size: 40px 40px, 20px 20px;
            opacity: 0.1;
            animation: pattern-move 10s linear infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-15px); }
            60% { transform: translateY(-8px); }
        }

        @keyframes rotate-slight {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-2deg); }
        }

        @keyframes pattern-move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }

        #dropArea.hover { 
            background: var(--drop-area-hover);
            border-color: var(--accent-color);
            transform: scale(1.03);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3), 0 0 50px var(--glow-color);
        }

        #dropArea p { margin: 0; font-size: 1.3em; font-weight: 500; }

        .hidden { display: none; }

        .panel { 
            background: var(--bg-panel-hover);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-top: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0.8;
            animation: panel-glow 3s ease-in-out infinite;
        }

        .panel::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            background: var(--glow-color);
            border-radius: 50%;
            opacity: 0.05;
            animation: corner-pulse 4s ease-in-out infinite;
        }

        @keyframes panel-glow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 20px var(--glow-color); }
        }

        @keyframes corner-pulse {
            0%, 100% { transform: scale(1); opacity: 0.05; }
            50% { transform: scale(1.2); opacity: 0.1; }
        }

        .panel:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.2), 0 0 50px var(--glow-color);
        }

        .panel h3 {
            margin-top: 0;
            color: var(--accent-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.4em;
            position: relative;
            z-index: 1;
        }

        .panel h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--accent-color);
            animation: title-glow 2s ease-in-out infinite;
        }

        @keyframes title-glow {
            0%, 100% { box-shadow: 0 0 10px var(--glow-color); }
            50% { box-shadow: 0 0 20px var(--glow-color); }
        }

        .info-grid {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 18px 30px;
            align-items: start;
            position: relative;
            z-index: 1;
        }

        .info-grid dt { 
            font-weight: bold; 
            color: var(--text-muted); 
            text-align: right; 
            padding-top: 2px;
            position: relative;
        }

        .info-grid dt::after {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--glow-color);
            animation: dot-pulse 2s ease-in-out infinite;
        }

        @keyframes dot-pulse {
            0%, 100% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.3); }
        }

        .info-grid dd { margin: 0; word-break: break-all; }
        .info-grid a { 
            color: var(--accent-color); 
            text-decoration: none; 
            transition: all 0.3s ease;
            position: relative;
        }
        .info-grid a:hover { 
            text-decoration: underline;
            filter: brightness(1.2);
            text-shadow: 0 0 10px var(--glow-color);
        }
        
        .tag-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            align-items: center; 
        }

        .tag {
            background: var(--bg); 
            padding: 10px 18px; 
            border-radius: 25px; 
            font-size: 14px;
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .tag:hover::before {
            left: 0;
        }

        .tag:hover { 
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 20px var(--glow-color);
        }
        
        .action-button {
            background: var(--btn-bg); 
            color: var(--text-color); 
            border: none;
            padding: 10px 20px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 12px;
            transition: all 0.3s ease; 
            text-decoration: none; 
            display: inline-block;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-secondary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .action-button:hover::before {
            left: 0;
        }

        .action-button:hover { 
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 20px var(--glow-color);
        }

        .copy-all-btn { font-weight: bold; }
        
        .copy-success { 
            background: var(--btn-action-bg) !important; 
            color: white !important; 
            cursor: default !important; 
        }

        #image-viewer { margin-top: 25px; text-align: center; }
        #civitai-preview-image { 
            max-width: 100%; 
            max-height: 70vh; 
            border-radius: 20px; 
            object-fit: contain; 
            background: var(--bg);
            transition: all 0.3s ease;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3), 0 0 30px var(--glow-color);
        }
        #civitai-preview-image:hover {
            transform: scale(1.03);
            box-shadow: 0 25px 60px rgba(0,0,0,0.4), 0 0 50px var(--glow-color);
        }

        #image-nav { 
            margin-top: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 20px; 
            flex-wrap: wrap; 
        }

        #image-nav button, #editor-actions button {
            background: var(--btn-bg); 
            color: var(--text-color); 
            border: none; 
            padding: 12px 24px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #image-nav button::before, #editor-actions button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        #image-nav button:hover::before, #editor-actions button:hover::before {
            left: 0;
        }

        #image-nav button:hover, #editor-actions button:hover { 
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 25px var(--glow-color);
        }

        #image-nav button:disabled { 
            background: var(--border-color); 
            cursor: not-allowed; 
            opacity: 0.5;
            transform: none;
        }

        #image-nav button:disabled::before {
            display: none;
        }

        #update-lora-button { 
            background: var(--gradient-secondary); 
            color: white;
        }
        
        .description-content {
            background: var(--bg); 
            padding: 25px; 
            border-radius: 15px; 
            margin-top: 20px;
            border: 1px solid var(--border-color); 
            max-height: 300px; 
            overflow-y: auto;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .description-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0.6;
        }

        .description-content * { max-width: 100%; word-wrap: break-word; }

        #metadata-editor-textarea {
            width: 100%; 
            height: 400px; 
            background: var(--bg); 
            color: var(--text-color);
            border: 2px solid var(--border-color); 
            border-radius: 15px; 
            font-family: "Fira Code", monospace;
            font-size: 14px; 
            box-sizing: border-box;
            transition: all 0.3s ease;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #metadata-editor-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--glow-color), 0 10px 25px rgba(0,0,0,0.2);
        }

        #editor-actions { margin-top: 20px; text-align: right; }

        pre { 
            background: var(--bg); 
            padding: 25px; 
            border-radius: 15px; 
            white-space: pre-wrap;
            word-break: break-all; 
            font-family: "Fira Code", monospace; 
            font-size: 14px;
            border: 1px solid var(--border-color); 
            max-height: 400px; 
            overflow-y: auto;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        pre::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0.6;
        }

        #loading { 
            display: none; 
            position: fixed; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 1.3rem; 
            color: var(--text-color); 
            background: var(--bg-panel); 
            backdrop-filter: blur(30px);
            padding: 40px; 
            border-radius: 20px; 
            z-index: 1001; 
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 30px 80px rgba(0,0,0,0.4), 0 0 50px var(--glow-color);
        }

        #loading .spinner { 
            margin: 25px auto; 
            border: 5px solid var(--border-color); 
            border-radius: 50%; 
            border-top: 5px solid var(--accent-color); 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
            box-shadow: 0 0 30px var(--glow-color);
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-panel);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 5px;
            box-shadow: 0 0 10px var(--glow-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--glow-color);
        }

        /* Smooth transitions for theme changes */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body>
  <!-- Geometric background -->
  <div class="geometric-bg" id="geometric-bg"></div>

  <!-- Enhanced particles -->
  <div class="particles" id="particles"></div>

  <div class="container" id="main-container">
    <div class="header">
        <span>✨ 解析lora元数据 ✨</span>
        <div class="controls-section">
            <div class="theme-selector">
                <div class="theme-btn active" data-theme="dark" title="深色主题"></div>
                <div class="theme-btn" data-theme="light" title="浅色主题"></div>
                <div class="theme-btn" data-theme="blue" title="蓝色主题"></div>
                <div class="theme-btn" data-theme="purple" title="紫色主题"></div>
                <div class="theme-btn" data-theme="green" title="绿色主题"></div>
                <div class="theme-btn" data-theme="orange" title="橙色主题"></div>
            </div>
            <div class="bg-selector">
                <div class="bg-btn active" data-bg="default" title="默认背景"></div>
                <div class="bg-btn" data-bg="gradient1" title="渐变1"></div>
                <div class="bg-btn" data-bg="gradient2" title="渐变2"></div>
                <div class="bg-btn" data-bg="gradient3" title="渐变3"></div>
                <div class="bg-btn" data-bg="gradient4" title="渐变4"></div>
                <div class="bg-btn" data-bg="pattern" title="图案"></div>
            </div>
        </div>
    </div>
    
    <div id="link-input-section">
        <input type="text" id="civitai-url-input" placeholder="🔗 粘贴 Civitai 模型或版本链接到这里...">
        <button id="parse-link-btn">🔍 解析链接</button>
        <button id="download-lora-btn" class="hidden">⬇️ 下载 LoRA</button>
    </div>

    <div id="dropArea">
      <p>将 .safetensors 文件拖拽到此处</p>
    </div>
    
    <div id="loading"><div class="loading-message"></div><div class="spinner"></div></div>

    <div id="resultsPanel" class="hidden">
      
      <div id="civitaiPanel" class="panel hidden">
        <h3>
            <span>🌐 Civitai 信息</span>
            <button id="export-triggers-btn" class="action-button hidden">📄 导出触发词</button>
        </h3>
        <dl class="info-grid">
          <dt>模型名称</dt><dd id="civitai-model-name">-</dd>
          <dt>创作者</dt><dd id="civitai-creator">-</dd>
          <dt>触发词</dt><dd id="civitai-trained-words" class="tag-container"></dd>
          <dt>基础模型</dt><dd id="civitai-base-model">-</dd>
          <dt>Civitai 链接</dt><dd><a id="civitai-link" href="#" target="_blank">🔗 点击查看</a></dd>
        </dl>
        <div id="image-viewer" class="hidden">
            <img id="civitai-preview-image" alt="Civitai Preview Image">
            <div id="image-nav" class="hidden">
                <button id="prev-image-btn">⬅️ 上一张</button>
                <span id="image-counter"></span>
                <button id="next-image-btn">➡️ 下一张</button>
                <button id="export-image-btn" class="action-button">🖼️ 导出图片</button>
            </div>
        </div>
      </div>

      <div id="trainingDetailsPanel" class="panel hidden">
        <h3>🎯 训练详情</h3>
        <dl class="info-grid">
            <dt>算法 (Algorithm)</dt><dd id="details-algo">-</dd>
            <dt>学习率 (LR)</dt><dd id="details-lr">-</dd>
            <dt>优化器 (Optimizer)</dt><dd id="details-optimizer">-</dd>
            <dt>图片总数</dt><dd id="details-total-images">-</dd>
            <dt>Resource Info</dt><dd><a id="details-resource-info" href="#" target="_blank">🔗 查看资源</a></dd>
        </dl>
      </div>
      
      <div id="descriptionPanel" class="panel hidden">
        <h3>
            <span>📝 模型介绍 & 版本信息</span>
            <button id="export-log-btn" class="action-button">💾 导出介绍</button>
        </h3>
        <h4>📖 模型介绍 (Description)</h4>
        <div id="civitai-description" class="description-content"></div>
        <h4 style="margin-top: 20px;">ℹ️ 版本信息 (Version Info)</h4>
        <div id="civitai-version-info" class="description-content"></div>
      </div>

      <div id="editorPanel" class="panel hidden">
        <h3>⚙️ 元数据编辑器</h3>
        <textarea id="metadata-editor-textarea"></textarea>
        <div id="editor-actions">
            <button id="update-lora-button">🔄 更新并下载 LoRA</button>
        </div>
      </div>

      <div id="metadataPanel" class="panel hidden">
        <h3>📊 文件元数据 (原始)</h3>
        <pre id="metadataDisplay"></pre>
      </div>

    </div>
  </div>

  <script>
    // --- Enhanced Particle System ---
    function createParticles() {
        const particlesContainer = document.getElementById('particles');
        const particleTypes = ['particle-small', 'particle-medium', 'particle-large', 'particle-glow'];
        const particleCount = 40; // Increased from 15
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            const type = particleTypes[Math.floor(Math.random() * particleTypes.length)];
            particle.className = `particle ${type}`;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (Math.random() * 15 + 15) + 's';
            particlesContainer.appendChild(particle);
        }
    }

    // --- Geometric Shapes System ---
    function createGeometricShapes() {
        const geometricContainer = document.getElementById('geometric-bg');
        const shapes = ['triangle', 'circle', 'square', 'hexagon'];
        const shapeCount = 25; // New geometric shapes
        
        for (let i = 0; i < shapeCount; i++) {
            const shape = document.createElement('div');
            const shapeType = shapes[Math.floor(Math.random() * shapes.length)];
            shape.className = `geometric-shape shape-${shapeType}`;
            shape.style.left = Math.random() * 100 + '%';
            shape.style.animationDelay = Math.random() * 25 + 's';
            shape.style.animationDuration = (Math.random() * 20 + 20) + 's';
            geometricContainer.appendChild(shape);
        }
    }

    // --- Mouse Trail Effect ---
    let mouseTrails = [];
    function createMouseTrail(e) {
        const trail = document.createElement('div');
        trail.className = 'mouse-trail';
        trail.style.left = e.clientX + 'px';
        trail.style.top = e.clientY + 'px';
        document.body.appendChild(trail);
        
        mouseTrails.push(trail);
        
        setTimeout(() => {
            if (trail.parentNode) {
                trail.parentNode.removeChild(trail);
            }
            mouseTrails = mouseTrails.filter(t => t !== trail);
        }, 1000);
    }

    // --- Ripple Effect ---
    function createRipple(e) {
        const button = e.currentTarget;
        const rect = button.getBoundingClientRect();
        const ripple = document.createElement('span');
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.className = 'ripple';
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        
        button.appendChild(ripple);
        
        setTimeout(() => {
            if (ripple.parentNode) {
                ripple.parentNode.removeChild(ripple);
            }
        }, 600);
    }

    // --- Theme Management ---
    const themeButtons = document.querySelectorAll('.theme-btn');
    const bgButtons = document.querySelectorAll('.bg-btn');
    const root = document.documentElement;

    // Set default theme
    setTheme('dark');
    setBackground('default');

    themeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            createRipple(e);
            const theme = btn.dataset.theme;
            setTheme(theme);
        });
    });

    bgButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            createRipple(e);
            const bg = btn.dataset.bg;
            setBackground(bg);
        });
    });

    function setTheme(theme) {
        root.setAttribute('data-theme', theme);
        themeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
    }

    function setBackground(bg) {
        bgButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.bg === bg);
        });

        const backgrounds = {
            'default': 'var(--bg)',
            'gradient1': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'gradient2': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'gradient3': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'gradient4': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'pattern': `
                radial-gradient(circle at 25% 25%, rgba(var(--accent-color), 0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(var(--accent-color), 0.1) 2px, transparent 2px),
                var(--bg)
            `
        };

        if (bg === 'pattern') {
            root.style.setProperty('--custom-bg', `
                radial-gradient(circle at 25% 25%, rgba(74, 171, 247, 0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(74, 171, 247, 0.1) 2px, transparent 2px)
            `);
            document.body.style.backgroundSize = '30px 30px';
        } else {
            root.style.setProperty('--custom-bg', backgrounds[bg]);
            document.body.style.backgroundSize = 'cover';
        }
    }

    // Initialize effects
    createParticles();
    createGeometricShapes();

    // Mouse trail effect
    let mouseTrailTimeout;
    document.addEventListener('mousemove', (e) => {
        clearTimeout(mouseTrailTimeout);
        mouseTrailTimeout = setTimeout(() => createMouseTrail(e), 50);
    });

    // Add ripple effect to all buttons
    document.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.classList.contains('theme-btn') || e.target.classList.contains('bg-btn')) {
            createRipple(e);
        }
    });

    // --- DOM Element References ---
    const urlInput = document.getElementById('civitai-url-input');
    const parseLinkBtn = document.getElementById('parse-link-btn');
    const downloadLoraBtn = document.getElementById('download-lora-btn');
    const dropArea = document.getElementById('dropArea');
    const loadingDiv = document.getElementById('loading');
    const loadingMessage = document.querySelector('.loading-message');
    const resultsPanel = document.getElementById('resultsPanel');
    const civitaiPanel = document.getElementById('civitaiPanel');
    const descriptionPanel = document.getElementById('descriptionPanel');
    const trainingDetailsPanel = document.getElementById('trainingDetailsPanel');
    const metadataPanel = document.getElementById('metadataPanel');
    const editorPanel = document.getElementById('editorPanel');
    const metadataDisplay = document.getElementById('metadataDisplay');
    const metadataEditorTextarea = document.getElementById('metadata-editor-textarea');
    const updateLoraButton = document.getElementById('update-lora-button');
    const imageViewer = document.getElementById('image-viewer');
    const previewImage = document.getElementById('civitai-preview-image');
    const imageNav = document.getElementById('image-nav');
    const prevBtn = document.getElementById('prev-image-btn');
    const nextBtn = document.getElementById('next-image-btn');
    const imageCounter = document.getElementById('image-counter');
    const trainedWordsDd = document.getElementById('civitai-trained-words');
    const exportLogBtn = document.getElementById('export-log-btn');
    const exportTriggersBtn = document.getElementById('export-triggers-btn');
    const exportImageBtn = document.getElementById('export-image-btn');

    // --- State Variables ---
    let currentImageIndex = 0;
    let imageUrls = [];
    let currentLoraFile = null;
    let currentCivitaiData = null;

    // --- Event Listeners ---
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.safetensors';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => handleFileSelect(fileInput.files[0]));
    dropArea.addEventListener('drop', e => handleFileSelect(e.dataTransfer.files[0]), false);
    
    parseLinkBtn.addEventListener('click', handleLinkParse);
    downloadLoraBtn.addEventListener('click', downloadLoraFromLink);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.add('hover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.remove('hover'), false);
    });
    
    prevBtn.addEventListener('click', showPreviousImage);
    nextBtn.addEventListener('click', showNextImage);
    exportLogBtn.addEventListener('click', exportDescription);
    exportTriggersBtn.addEventListener('click', exportTriggerWords);
    exportImageBtn.addEventListener('click', exportCurrentImage);
    updateLoraButton.addEventListener('click', updateAndDownloadLora);

    // --- Main Handlers ---
    function handleFileSelect(file) {
        if (!file || !file.name.endsWith('.safetensors')) {
            alert('请提供一个有效的 .safetensors 文件。');
            return;
        }
        currentLoraFile = file;
        urlInput.value = '';
        processLora();
    }
    
    async function handleLinkParse() {
        const url = urlInput.value.trim();
        if (!url) {
            alert('请输入一个Civitai链接。');
            return;
        }
        const match = url.match(/civitai\.com\/models\/(\d+)(?:\S*modelVersionId=(\d+))?/);
        if (!match) {
            alert('链接格式无效，请输入一个有效的Civitai模型或版本链接。');
            return;
        }
        const modelId = match[1];
        const versionId = match[2];

        clearResults();
        showLoading('正在通过链接解析...');

        try {
            let civitaiData;
            if (versionId) {
                civitaiData = await fetchCivitaiDataById(versionId, 'version');
            } else {
                const modelData = await fetchCivitaiDataById(modelId, 'model');
                if (modelData && modelData.modelVersions && modelData.modelVersions.length > 0) {
                    civitaiData = await fetchCivitaiDataById(modelData.modelVersions[0].id, 'version');
                }
            }

            if (civitaiData) {
                currentCivitaiData = civitaiData;
                metadataPanel.classList.add('hidden');
                trainingDetailsPanel.classList.add('hidden');
                editorPanel.classList.add('hidden');
                
                displayCivitaiData(civitaiData);
                civitaiPanel.classList.remove('hidden');
                descriptionPanel.classList.remove('hidden');
                resultsPanel.classList.remove('hidden');
                downloadLoraBtn.classList.remove('hidden');
            } else {
                alert('无法从链接获取信息，请检查链接或稍后再试。');
            }
        } catch(error) {
            console.error('通过链接解析时发生错误:', error);
            alert(`通过链接解析时发生错误: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    async function processLora() {
      showLoading('正在处理文件...');
      try {
        const metadata = await parseSafetensorsMetadata(currentLoraFile);
        showLoading('正在计算哈希值...');
        const hash = await calculateFileHash(currentLoraFile);
        const shortHash = hash.substring(0, 10);
        showLoading('正在查询 Civitai...');
        const civitaiData = await fetchCivitaiDataByHash(shortHash);
        currentCivitaiData = civitaiData;

        if (metadata) {
            displayInternalMetadata(metadata, shortHash);
            metadataPanel.classList.remove('hidden');
            trainingDetailsPanel.classList.remove('hidden');
            editorPanel.classList.remove('hidden');
        }
        if (civitaiData) {
          displayCivitaiData(civitaiData);
          civitaiPanel.classList.remove('hidden');
          descriptionPanel.classList.remove('hidden');
        }
        resultsPanel.classList.remove('hidden');
      } catch (error) {
        console.error('处理文件时发生错误:', error);
        alert(`处理文件时发生错误: ${error.message}`);
      } finally {
        hideLoading();
      }
    }
    
    // --- UI Update & Display Functions ---
    function showLoading(message) {
        loadingMessage.textContent = message;
        loadingDiv.style.display = 'block';
    }

    function hideLoading() {
        loadingDiv.style.display = 'none';
    }

    function clearResults() {
        resultsPanel.classList.add('hidden');
        civitaiPanel.classList.add('hidden');
        descriptionPanel.classList.add('hidden');
        trainingDetailsPanel.classList.add('hidden');
        metadataPanel.classList.add('hidden');
        editorPanel.classList.add('hidden');
        imageViewer.classList.add('hidden');
        imageNav.classList.add('hidden');
        exportTriggersBtn.classList.add('hidden');
        downloadLoraBtn.classList.add('hidden');
        imageUrls = [];
        currentImageIndex = 0;
        currentLoraFile = null;
        currentCivitaiData = null;
    }

    function displayInternalMetadata(metadata, hash) {
        const coloredJson = JSON.stringify(metadata, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;');
        metadataDisplay.innerHTML = coloredJson;
        metadataEditorTextarea.value = JSON.stringify(metadata, null, 2);
        
        const networkArgs = metadata.ss_network_args ? JSON.parse(metadata.ss_network_args) : {};
        document.getElementById('details-algo').textContent = networkArgs.algo || '未知';
        document.getElementById('details-lr').textContent = metadata.ss_learning_rate || '未知';
        document.getElementById('details-optimizer').textContent = metadata.ss_optimizer_type || (metadata.ss_optimizer || '').split('(')[0].trim() || '未知';
        let totalImages = 0;
        if (metadata.ss_dataset_dirs) {
            try {
                const datasets = JSON.parse(metadata.ss_dataset_dirs);
                totalImages = Object.values(datasets).reduce((sum, dir) => sum + (dir.img_count || 0), 0);
            } catch(e) { console.error("无法解析ss_dataset_dirs"); }
        }
        document.getElementById('details-total-images').textContent = totalImages > 0 ? totalImages : '未知';
        const resourceLink = document.getElementById('details-resource-info');
        const resourceUrl = `https://civitai.com/api/v1/model-versions/by-hash/${hash}`;
        resourceLink.href = resourceUrl;
        resourceLink.textContent = resourceUrl;
    }
    
    function displayCivitaiData(data) {
        document.getElementById('civitai-model-name').textContent = data.model?.name || '未知';
        document.getElementById('civitai-creator').textContent = data.model?.creator?.username || '未知';
        document.getElementById('civitai-base-model').textContent = data.baseModel || '未知';
        
        trainedWordsDd.innerHTML = ''; 
        const words = data.trainedWords;
        if (words && words.length > 0) {
            words.forEach(word => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = word;
                tag.onclick = (e) => copyToClipboard(word, e.target);
                trainedWordsDd.appendChild(tag);
            });
            const copyAll = document.createElement('button');
            copyAll.className = 'action-button copy-all-btn';
            copyAll.textContent = '📋 复制全部';
            copyAll.onclick = (e) => copyToClipboard(words.join(', '), e.target);
            trainedWordsDd.appendChild(copyAll);
            exportTriggersBtn.classList.remove('hidden');
        } else {
            trainedWordsDd.textContent = '无';
            exportTriggersBtn.classList.add('hidden');
        }

        const link = document.getElementById('civitai-link');
        const modelUrl = `https://civitai.com/models/${data.modelId}?modelVersionId=${data.id}`;
        link.href = modelUrl;
        link.textContent = '🔗 在 Civitai.com 上查看';
        
        document.getElementById('civitai-description').innerHTML = data.model?.description || '无';
        document.getElementById('civitai-version-info').innerHTML = data.description || '无';

        if (data.images && data.images.length > 0) {
            imageUrls = data.images.map(img => img.url);
            currentImageIndex = 0;
            updateImageViewer();
            imageViewer.classList.remove('hidden');
        }
    }
    
    // --- Feature Functions ---
    function copyToClipboard(text, element) {
        if (text && text !== '无' && text !== '-') {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.textContent;
                element.textContent = '✅ 复制成功!';
                element.classList.add('copy-success');
                setTimeout(() => {
                    element.textContent = originalText;
                    element.classList.remove('copy-success');
                }, 1500);
            }).catch(err => {
                console.error('无法复制文本: ', err);
            });
        }
    }

    function exportContent(content, filename) {
        const baseName = currentLoraFile?.name.replace('.safetensors', '') || `civitai_${document.getElementById('civitai-model-name').textContent.replace(/\s/g, '_')}`;
        const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${baseName}${filename}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    function exportDescription() {
        const modelDesc = document.getElementById('civitai-description').innerText;
        const versionDesc = document.getElementById('civitai-version-info').innerText;
        const content = `--- 模型介绍 ---\n\n${modelDesc}\n\n--- 版本信息 ---\n\n${versionDesc}`;
        exportContent(content, `.log`);
    }

    function exportTriggerWords() {
        const wordsContainer = document.getElementById('civitai-trained-words');
        const tags = Array.from(wordsContainer.querySelectorAll('.tag')).map(t => t.textContent);
        if(tags.length > 0) {
            exportContent(tags.join(', '), `.txt`);
        }
    }
    
    async function exportCurrentImage() {
        if (imageUrls.length === 0) return;
        const url = imageUrls[currentImageIndex];
        
        showLoading(`正在下载图片...`);
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`无法获取图片: ${response.statusText}`);
            const blob = await response.blob();
            
            let extension = '.jpg';
            try {
                const urlPath = new URL(url).pathname;
                const urlParts = urlPath.split('.');
                if (urlParts.length > 1) {
                    const ext = urlParts.pop().toLowerCase();
                    if (['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(ext)) {
                        extension = `.${ext}`;
                    }
                }
            } catch(e) { console.error("无法从URL解析图片格式, 默认使用.jpg"); }
            
            const baseName = currentLoraFile?.name.replace('.safetensors', '') || `civitai_${document.getElementById('civitai-model-name').textContent.replace(/\s/g, '_')}`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${baseName}_image_${currentImageIndex}${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (error) {
            console.error('图片下载失败:', error);
            alert(`图片下载失败: ${error.message}. 您可以尝试右键点击图片手动保存。`);
        } finally {
            hideLoading();
        }
    }
    
    async function updateAndDownloadLora() {
        if (!currentLoraFile) {
            alert("请先加载一个LoRA文件。");
            return;
        }
        let newMetadata;
        try {
            newMetadata = JSON.parse(metadataEditorTextarea.value);
        } catch(e) {
            alert("元数据格式错误！请确保内容是有效的JSON。");
            return;
        }
        showLoading('正在重新构建文件...');
        try {
            const fileBuffer = await currentLoraFile.arrayBuffer();
            const view = new DataView(fileBuffer);
            const metadataLength = Number(view.getBigUint64(0, true));
            const newHeader = { "__metadata__": newMetadata };
            const newHeaderBytes = new TextEncoder().encode(JSON.stringify(newHeader));
            const newFileBuffer = new ArrayBuffer(8 + newHeaderBytes.length + (fileBuffer.byteLength - 8 - metadataLength));
            const newView = new DataView(newFileBuffer);
            newView.setBigUint64(0, BigInt(newHeaderBytes.length), true);
            const newUint8Array = new Uint8Array(newFileBuffer);
            newUint8Array.set(newHeaderBytes, 8);
            const tensorData = new Uint8Array(fileBuffer, 8 + metadataLength);
            newUint8Array.set(tensorData, 8 + newHeaderBytes.length);
            const blob = new Blob([newFileBuffer], { type: "application/octet-stream" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${currentLoraFile.name.replace('.safetensors', '')}_edited.safetensors`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch(error) {
            alert(`更新文件失败: ${error.message}`);
            console.error(error);
        } finally {
            hideLoading();
        }
    }

    async function downloadLoraFromLink() {
        if (!currentCivitaiData || !currentCivitaiData.downloadUrl) {
            alert('没有可用的下载链接。');
            return;
        }
        showLoading('正在准备下载 LoRA...');
        try {
            const filename = currentCivitaiData.files[0]?.name || 'lora.safetensors';
            const a = document.createElement('a');
            a.href = currentCivitaiData.downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch(error) {
            console.error('LoRA 下载失败:', error);
            alert(`LoRA 下载失败: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    // --- Image Viewer Logic ---
    function updateImageViewer() {
        if (imageUrls.length === 0) return;
        previewImage.src = imageUrls[currentImageIndex];
        imageCounter.textContent = `${currentImageIndex + 1} / ${imageUrls.length}`;
        prevBtn.disabled = currentImageIndex === 0;
        nextBtn.disabled = currentImageIndex === imageUrls.length - 1;
        imageNav.classList.toggle('hidden', imageUrls.length < 1);
    }
    function showNextImage() {
        if (currentImageIndex < imageUrls.length - 1) {
            currentImageIndex++;
            updateImageViewer();
        }
    }
    function showPreviousImage() {
        if (currentImageIndex > 0) {
            currentImageIndex--;
            updateImageViewer();
        }
    }

    // --- Core File & API Functions ---
    async function parseSafetensorsMetadata(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const buffer = e.target.result;
            const view = new DataView(buffer);
            const metadataLength = Number(view.getBigUint64(0, true));
            if (metadataLength === 0) { resolve(null); return; }
            const metadataJson = new TextDecoder().decode(new Uint8Array(buffer, 8, metadataLength));
            const header = JSON.parse(metadataJson);
            resolve(header['__metadata__'] || null);
          } catch (err) { reject(new Error("解析元数据失败。")); }
        };
        reader.onerror = () => reject(new Error('无法读取文件。'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function calculateFileHash(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const buffer = e.target.result;
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    resolve(hashArray.map(b => b.toString(16).padStart(2, '0')).join(''));
                } catch (err) { reject(err); }
            };
            reader.onerror = () => reject(new Error('无法读取文件以计算哈希。'));
            reader.readAsArrayBuffer(file);
        });
    }

    async function fetchCivitaiDataByHash(hash) {
      try {
        const response = await fetch(`https://civitai.com/api/v1/model-versions/by-hash/${hash}`);
        if (!response.ok) return null;
        let data = await response.json();
        const modelResponse = await fetch(`https://civitai.com/api/v1/models/${data.modelId}`);
        data.model = await modelResponse.json();
        return data;
      } catch (error) {
        console.error("Civitai API 请求失败 (by hash):", error);
        return null;
      }
    }
    
    async function fetchCivitaiDataById(id, type = 'version') {
        let url;
        if (type === 'version') {
            url = `https://civitai.com/api/v1/model-versions/${id}`;
        } else {
            url = `https://civitai.com/api/v1/models/${id}`;
        }
        try {
            const response = await fetch(url);
            if (!response.ok) return null;
            let data = await response.json();
            if (type === 'version' && data.modelId) {
                const modelResponse = await fetch(`https://civitai.com/api/v1/models/${data.modelId}`);
                data.model = await modelResponse.json();
            }
            return data;
        } catch (error) {
            console.error(`Civitai API 请求失败 (by ${type} id):`, error);
            return null;
        }
    }
  </script>
</body>
</html>